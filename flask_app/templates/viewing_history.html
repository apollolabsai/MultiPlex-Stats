{% extends "base.html" %}

{% block title %}Viewing History - MultiPlex Stats{% endblock %}

{% block content %}
<header class="history-hero" id="history-hero">
    <div class="history-hero-backdrop" id="history-hero-backdrop" aria-hidden="true"></div>
    <div class="history-hero-overlay" aria-hidden="true"></div>
    <h1 class="settings-title">Viewing History</h1>
    <div class="subtitle" id="history-subtitle">Complete playback records from all servers</div>
</header>

<div class="stats-grid" id="stats-grid">
    <div class="stat-card">
        <div class="stat-number" id="stat-total-plays">-</div>
        <div class="stat-label">Total Plays</div>
    </div>
    <div class="stat-card">
        <div class="stat-number" id="stat-total-users">-</div>
        <div class="stat-label">Active Users</div>
    </div>
    <!-- Server-specific cards will be added dynamically -->
</div>

<div class="section">
    <div class="table-container">
        <table id="viewingHistoryTable" class="display" style="width:100%">
            <thead>
                <tr>
                    <th style="width: 120px;">Date</th>
                    <th style="display:none;">Sortable DateTime</th>
                    <th style="width: 80px;">Server</th>
                    <th style="width: 100px;">User</th>
                    <th style="width: 300px;">Content</th>
                    <th style="width: 100px;">IP Address</th>
                    <th style="width: 100px;">Platform</th>
                    <th style="width: 80px;">Quality</th>
                    <th style="width: 120px;">Progress</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data loaded via AJAX -->
            </tbody>
        </table>
    </div>
</div>

<div class="geo-modal" id="geo-modal" aria-hidden="true">
    <div class="geo-modal-backdrop" data-geo-close="true"></div>
    <div class="geo-modal-card" role="dialog" aria-modal="true">
        <div class="geo-modal-header">
            <div class="geo-modal-title" id="geo-modal-title">IP Address</div>
            <button class="geo-modal-close" type="button" data-geo-close="true">Ã—</button>
        </div>
        <div class="geo-modal-body">
            <div class="geo-section">
                <div class="geo-section-title">Connection Details</div>
                <div class="geo-row">
                    <span class="geo-label">Location</span>
                    <span class="geo-value" id="geo-modal-location">Unknown</span>
                </div>
            </div>
            <div class="geo-section">
                <div class="geo-section-title">Geolocation Lookup</div>
                <div class="geo-row">
                    <span class="geo-label">City</span>
                    <span class="geo-value" id="geo-modal-city">Unknown</span>
                </div>
                <div class="geo-row">
                    <span class="geo-label">Region</span>
                    <span class="geo-value" id="geo-modal-region">Unknown</span>
                </div>
                <div class="geo-row">
                    <span class="geo-label">Country</span>
                    <span class="geo-value" id="geo-modal-country">Unknown</span>
                </div>
                <div class="geo-row">
                    <span class="geo-label">ISP</span>
                    <span class="geo-value" id="geo-modal-isp">Unknown</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="nav-loading-overlay" id="nav-loading-overlay" aria-hidden="true">
    <div class="nav-loading-card" role="status" aria-live="polite">
        <div class="nav-loading-title" id="nav-loading-title">Loading content details...</div>
        <div class="nav-loading-subtitle" id="nav-loading-subtitle">Please wait</div>
        <div class="nav-loading-bar-track">
            <div class="nav-loading-bar-fill"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- DataTables CSS and JS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>

<style>
.history-hero {
    position: relative;
    overflow: hidden;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    background: #171717;
    padding: 20px 22px;
    margin-bottom: 16px;
}

.history-hero-backdrop {
    position: absolute;
    inset: 0;
    opacity: 0.5;
    display: grid;
    grid-template-columns: repeat(5, minmax(0, 1fr));
    grid-template-rows: repeat(4, minmax(0, 1fr));
}

.history-hero-tile {
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
}

.history-hero-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(10, 10, 10, 0.9) 0%, rgba(14, 14, 14, 0.68) 55%, rgba(12, 12, 12, 0.86) 100%);
}

.history-hero .settings-title,
.history-hero .subtitle {
    position: relative;
    z-index: 2;
}

.history-hero .subtitle {
    max-width: 560px;
}

#stats-grid .stat-card {
    padding: 12px 16px;
}

#stats-grid .stat-number {
    font-size: 1.5em;
    margin-bottom: 2px;
    line-height: 1.1;
}

#stats-grid .stat-label {
    font-size: 0.72em;
    letter-spacing: 0.06em;
}

.ip-cell {
    display: flex;
    align-items: center;
    gap: 8px;
}

.ip-text {
    color: #fff;
    font-size: 0.9em;
}

.geo-trigger {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 26px;
    height: 26px;
    border-radius: 50%;
    border: 1px solid rgba(241, 138, 61, 0.5);
    background: rgba(241, 138, 61, 0.12);
    color: #f18a3d;
    cursor: pointer;
    transition: transform 0.2s ease, background 0.2s ease;
}

.geo-trigger svg {
    width: 14px;
    height: 14px;
    fill: currentColor;
}

.geo-trigger:hover {
    transform: translateY(-1px);
    background: rgba(241, 138, 61, 0.2);
}

.geo-modal {
    position: fixed;
    inset: 0;
    display: none;
    z-index: 12000;
}

.geo-modal.is-open {
    display: block;
}

.geo-modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
}

.geo-modal-card {
    position: relative;
    width: min(520px, 90vw);
    margin: 10vh auto;
    background: #1b1b1b;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    box-shadow: 0 24px 60px rgba(0, 0, 0, 0.45);
    padding: 20px 24px;
}

.geo-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
}

.geo-modal-title {
    font-size: 1.05em;
    font-weight: 600;
    color: #fff;
}

.geo-modal-close {
    border: none;
    background: transparent;
    color: #aaa;
    font-size: 1.4em;
    cursor: pointer;
}

.geo-modal-body {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.geo-section-title {
    font-size: 0.95em;
    color: #f18a3d;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
}

.geo-row {
    display: flex;
    justify-content: space-between;
    gap: 12px;
    padding: 4px 0;
}

.geo-label {
    color: #9e9e9e;
    font-size: 0.9em;
}

.geo-value {
    color: #fff;
    font-size: 0.9em;
    text-align: right;
}

.content-link {
    color: #f18a3d;
    text-decoration: none;
    border-bottom: 1px dotted rgba(241, 138, 61, 0.6);
}

.content-link:hover {
    color: #ffaf6e;
}

.nav-loading-overlay {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.6);
    z-index: 13000;
    backdrop-filter: blur(2px);
}

.nav-loading-overlay.is-open {
    display: flex;
}

.nav-loading-card {
    width: min(420px, 86vw);
    background: #1b1b1b;
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 24px 60px rgba(0, 0, 0, 0.45);
}

.nav-loading-title {
    color: #fff;
    font-size: 1.02em;
    font-weight: 600;
}

.nav-loading-subtitle {
    margin-top: 4px;
    color: #bdbdbd;
    font-size: 0.9em;
}

.nav-loading-bar-track {
    margin-top: 14px;
    width: 100%;
    height: 4px;
    border-radius: 999px;
    overflow: hidden;
    background: rgba(255, 255, 255, 0.12);
}

.nav-loading-bar-fill {
    width: 38%;
    height: 100%;
    background: linear-gradient(90deg, #e6b413 0%, #f18a3d 70%, #ed542c 100%);
    border-radius: 999px;
    animation: nav-loading-slide 1.1s ease-in-out infinite;
}

@keyframes nav-loading-slide {
    0% {
        transform: translateX(-120%);
    }
    100% {
        transform: translateX(280%);
    }
}

@media (max-width: 820px) {
    .history-hero {
        padding: 18px 18px;
    }
}
</style>

<script>
$(document).ready(function() {
    // Movie icon SVG
    var movieIcon = '<svg class="media-icon" fill="#ed542c" viewBox="0 0 24 24"><path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"/></svg>';
    // TV icon SVG
    var tvIcon = '<svg class="media-icon" fill="#ed542c" viewBox="0 0 24 24"><path d="M21 3H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h5v2h8v-2h5c1.1 0 1.99-.9 1.99-2L23 5c0-1.1-.9-2-2-2zm0 14H3V5h18v12z"/></svg>';
    var contentDetailBase = '{{ url_for("main.content_details", history_id=0) }}';
    var navigationInProgress = false;
    var historyHeroBackdrop = document.getElementById('history-hero-backdrop');

    function renderHistoryHeroPosters(posters) {
        if (!historyHeroBackdrop) {
            return;
        }

        historyHeroBackdrop.innerHTML = '';
        if (!Array.isArray(posters) || posters.length === 0) {
            return;
        }

        var normalizedPosters = posters.filter(function(item) {
            return item && item.poster_url;
        });
        if (normalizedPosters.length === 0) {
            return;
        }

        for (var i = 0; i < 20; i++) {
            var item = normalizedPosters[i % normalizedPosters.length];
            var posterUrl = String(item.poster_url || '').replace(/"/g, '\\"');
            var tile = document.createElement('div');
            tile.className = 'history-hero-tile';
            tile.style.backgroundImage = 'url("' + posterUrl + '")';
            if (item.title) {
                tile.setAttribute('title', item.title);
            }
            historyHeroBackdrop.appendChild(tile);
        }
    }

    function loadHistoryHeroPosters() {
        fetch('{{ url_for("main.api_viewing_history_posters") }}')
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('Failed to load poster background.');
                }
                return response.json();
            })
            .then(function(payload) {
                renderHistoryHeroPosters(payload.posters || []);
            })
            .catch(function(error) {
                console.error('Error loading viewing history posters:', error);
            });
    }

    function showNavigationLoading(titleText) {
        var overlay = document.getElementById('nav-loading-overlay');
        var titleEl = document.getElementById('nav-loading-title');
        var subtitleEl = document.getElementById('nav-loading-subtitle');
        if (!overlay || !titleEl || !subtitleEl) {
            return;
        }

        titleEl.textContent = 'Loading content details...';
        if (titleText) {
            subtitleEl.textContent = titleText;
        } else {
            subtitleEl.textContent = 'Please wait';
        }

        overlay.classList.add('is-open');
        overlay.setAttribute('aria-hidden', 'false');
    }

    $('#viewingHistoryTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: '{{ url_for("main.api_viewing_history") }}',
            type: 'GET'
        },
        pageLength: 50,
        order: [[0, 'desc']], // Sort by date column (most recent first)
        lengthMenu: [[25, 50, 100, 200], [25, 50, 100, 200]],
        columns: [
            // Date & Time
            {
                data: null,
                render: function(data, type, row) {
                    return '<div class="datetime-cell">' +
                           '<span class="date-text">' + (row.date_pt || '') + '</span>' +
                           '<span class="time-text">' + (row.time_pt || '') + '</span>' +
                           '</div>';
                }
            },
            // Hidden sortable datetime
            { data: 'sortable_datetime', visible: false },
            // Server
            {
                data: null,
                render: function(data, type, row) {
                    return '<span class="server-badge ' + (row.server_order || '') + '">' +
                           (row.Server || '') + '</span>';
                }
            },
            // User
            { data: 'user' },
            // Content
            {
                data: null,
                render: function(data, type, row) {
                    var icon = (row.media_type || '').toLowerCase() === 'movie' ? movieIcon : tvIcon;
                    var titleText = row.title || '';
                    var titleHtml = '<span class="content-title">' + titleText + '</span>';
                    if (row.history_id) {
                        var detailUrl = contentDetailBase.replace(/0$/, String(row.history_id));
                        titleHtml = '<a class="content-title content-link" href="' + detailUrl + '">' + titleText + '</a>';
                    }

                    var html = '<div class="content-cell"><div>' + icon + titleHtml + '</div>';
                    if (row.subtitle) {
                        html += '<div class="content-subtitle">' + row.subtitle + '</div>';
                    }
                    html += '</div>';
                    return html;
                }
            },
            // IP Address
            {
                data: null,
                render: function(data, type, row) {
                    var ip = row.ip_address || '';
                    if (type === 'sort' || type === 'type') {
                        return ip;
                    }

                    var ipAttr = ip.replace(/"/g, '&quot;');

                    return '<div class="ip-cell">' +
                           '<button class="geo-trigger" type="button" ' +
                           'data-ip="' + ipAttr + '">' +
                           '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5S13.38 11.5 12 11.5z"/></svg>' +
                           '</button>' +
                           '<span class="ip-text">' + ip + '</span>' +
                           '</div>';
                }
            },
            // Platform
            {
                data: null,
                render: function(data, type, row) {
                    var html = '<div class="content-cell">' +
                               '<div class="platform-name">' + (row.platform || '') + '</div>';
                    if (row.product) {
                        html += '<div class="platform-product">' + row.product + '</div>';
                    }
                    html += '</div>';
                    return html;
                }
            },
            // Quality
            {
                data: null,
                render: function(data, type, row) {
                    if (!row.quality) {
                        return '<span style="color: #888;">N/A</span>';
                    }
                    var badgeClass = 'quality-badge';
                    if (row.quality === 'Direct Play') badgeClass += ' direct-play';
                    else if (row.quality === 'Transcode') badgeClass += ' transcode';
                    else if (row.quality === 'Direct Stream') badgeClass += ' direct-stream';
                    return '<span class="' + badgeClass + '">' + row.quality + '</span>';
                }
            },
            // Progress
            {
                data: null,
                render: function(data, type, row) {
                    var percent = row.percent_complete || 0;
                    return '<div class="progress-bar-container">' +
                           '<div class="progress-bar-fill orange" style="width: ' + percent + '%;"></div>' +
                           '</div>' +
                           '<div class="progress-text">' + percent + '%</div>';
                }
            }
        ],
        columnDefs: [
            { targets: 1, visible: false } // Hide the sortable datetime column
        ],
        language: {
            search: "Filter records:",
            lengthMenu: "Show _MENU_ entries",
            info: "Showing _START_ to _END_ of _TOTAL_ viewing records",
            infoEmpty: "No history loaded yet - go to Settings to Import Viewing History.",
            emptyTable: "No history loaded yet - go to Settings to Import Viewing History.",
            infoFiltered: "(filtered from _MAX_ total records)",
            processing: "Loading..."
        }
    });

    function showGeoModal(data) {
        var modal = document.getElementById('geo-modal');
        if (!modal) {
            return;
        }

        document.getElementById('geo-modal-title').textContent = 'IP Address: ' + (data.ip || 'Unknown');
        document.getElementById('geo-modal-location').textContent = data.location || 'Unknown';
        document.getElementById('geo-modal-city').textContent = data.city || 'Unknown';
        document.getElementById('geo-modal-region').textContent = data.region || 'Unknown';
        document.getElementById('geo-modal-country').textContent = data.country || 'Unknown';
        document.getElementById('geo-modal-isp').textContent = data.isp || 'Unknown';

        modal.classList.add('is-open');
        modal.setAttribute('aria-hidden', 'false');
    }

    function closeGeoModal() {
        var modal = document.getElementById('geo-modal');
        if (!modal) {
            return;
        }
        modal.classList.remove('is-open');
        modal.setAttribute('aria-hidden', 'true');
    }

    $('#viewingHistoryTable').on('click', '.geo-trigger', function() {
        var button = this;
        var ip = button.getAttribute('data-ip') || '';
        showGeoModal({
            ip: ip,
            location: 'Loading...',
            city: 'Loading...',
            region: 'Loading...',
            country: 'Loading...',
            isp: 'Loading...'
        });

        fetch('{{ url_for("main.api_ip_lookup") }}?ip=' + encodeURIComponent(ip))
            .then(function(response) {
                if (!response.ok) {
                    return response.json().then(function(payload) {
                        throw new Error(payload.error || 'Lookup failed.');
                    });
                }
                return response.json();
            })
            .then(function(payload) {
                showGeoModal({
                    ip: payload.ip || ip,
                    location: payload.location || 'Unknown',
                    city: payload.city || 'Unknown',
                    region: payload.region || 'Unknown',
                    country: payload.country || 'Unknown',
                    isp: payload.isp || 'Unknown'
                });
            })
            .catch(function(error) {
                showGeoModal({
                    ip: ip,
                    location: 'Unknown',
                    city: 'Unknown',
                    region: 'Unknown',
                    country: 'Unknown',
                    isp: 'Unknown'
                });
                alert(error.message || 'Unable to lookup IP location.');
            });
    });

    $(document).on('click', '[data-geo-close="true"]', function() {
        closeGeoModal();
    });

    $(document).on('keydown', function(event) {
        if (event.key === 'Escape') {
            closeGeoModal();
        }
    });

    // Fetch and display viewing history stats
    function loadStats() {
        fetch('{{ url_for("main.api_viewing_history_stats") }}')
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('Failed to load stats');
                }
                return response.json();
            })
            .then(function(data) {
                // Update the stat cards
                document.getElementById('stat-total-plays').textContent = data.total_plays.toLocaleString();
                document.getElementById('stat-total-users').textContent = data.total_users.toLocaleString();

                // Update subtitle with days and date range
                if (data.days_of_history > 0 && data.oldest_date && data.newest_date) {
                    var formatDate = function(dateStr) {
                        var parts = dateStr.split('-');
                        var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                        return months[parseInt(parts[1], 10) - 1] + ' ' + parseInt(parts[2], 10) + ', ' + parts[0];
                    };
                    var subtitle = data.days_of_history.toLocaleString() + ' Days | ' + formatDate(data.oldest_date) + ' - ' + formatDate(data.newest_date);
                    document.getElementById('history-subtitle').textContent = subtitle;
                }

                // Add server-specific cards dynamically
                var statsGrid = document.getElementById('stats-grid');
                statsGrid.querySelectorAll('.server-stat-card').forEach(function(card) {
                    card.remove();
                });
                data.servers.forEach(function(server) {
                    var card = document.createElement('div');
                    card.className = 'stat-card server-stat-card';
                    card.innerHTML = '<div class="stat-number">' + server.plays.toLocaleString() + '</div>' +
                                     '<div class="stat-label">' + server.name + ' Plays</div>';
                    statsGrid.appendChild(card);
                });
            })
            .catch(function(error) {
                console.error('Error loading stats:', error);
            });
    }

    // Load stats on page load
    loadStats();
    loadHistoryHeroPosters();

    $('#viewingHistoryTable').on('click', 'a.content-link', function(event) {
        var href = this.getAttribute('href');
        if (!href) {
            return;
        }

        // Preserve expected browser behavior for new-tab gestures.
        if (event.metaKey || event.ctrlKey || event.shiftKey || event.altKey || event.button !== 0) {
            return;
        }

        event.preventDefault();
        if (navigationInProgress) {
            return;
        }

        navigationInProgress = true;
        var titleText = (this.textContent || '').trim();
        showNavigationLoading(titleText);

        // Let the overlay paint before navigation starts.
        window.setTimeout(function() {
            window.location.href = href;
        }, 35);
    });
});
</script>
{% endblock %}
