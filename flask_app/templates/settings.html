{% extends "base.html" %}

{% block title %}Settings - MultiPlex Stats{% endblock %}

{% block content %}
<header>
    <h1 class="settings-title">Settings</h1>
    <div class="subtitle">Configure Your Tautulli Servers & Analytics Preferences</div>
</header>

<div class="settings-container">
    <div class="settings-section">
        <h2 class="section-title">
            <svg class="section-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                <line x1="8" y1="21" x2="16" y2="21"></line>
                <line x1="12" y1="17" x2="12" y2="21"></line>
            </svg>
            Server Configuration
        </h2>

        {% if servers %}
            <div class="server-list">
                {% for server in servers %}
                <div class="server-item">
                    <div class="server-info">
                        <h3>{{ server.name }}</h3>
                        <p>{{ "https" if server.use_ssl else "http" }}://{{ server.ip_address }}</p>
                        <p class="server-meta">Order: {{ "ServerA" if server.server_order == 0 else "ServerB" }}{% if server.use_ssl %} | SSL: ✓{% endif %}</p>
                    </div>
                    <div class="server-actions">
                        <form method="POST" action="{{ url_for('settings.delete_server', server_id=server.id) }}" style="display: inline;">
                            <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this server?');">Delete</button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="info-message">No servers configured. Add your first server below.</p>
        {% endif %}

        <div class="form-card">
            <h3>Add/Update Server</h3>
            <form method="POST" action="{{ url_for('settings.add_server') }}">
                <div class="form-group">
                    <label for="name">Server Name</label>
                    <input type="text" id="name" name="name" required placeholder="e.g., Server1">
                </div>

                <div class="form-group">
                    <label for="ip_address">IP Address:Port</label>
                    <input type="text" id="ip_address" name="ip_address" required placeholder="e.g., 192.168.1.101:8181">
                    <small>Include the port number</small>
                </div>

                <div class="form-group">
                    <label for="api_key">API Key</label>
                    <input type="text" id="api_key" name="api_key" required placeholder="Your Tautulli API key">
                    <small>Find in Tautulli: Settings → Web Interface → API</small>
                </div>

                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" id="use_ssl" name="use_ssl" value="1">
                        Use HTTPS/SSL
                    </label>
                    <small>Check this if your Tautulli server uses HTTPS</small>
                </div>

                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" id="verify_ssl" name="verify_ssl" value="1">
                        Verify SSL Certificate
                    </label>
                    <small>Check this only if using HTTPS with a valid certificate</small>
                </div>

                <div class="form-group">
                    <label for="server_order">Server Order</label>
                    <select id="server_order" name="server_order">
                        <option value="0">Server A (Primary)</option>
                        <option value="1">Server B (Secondary)</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary">Save Server</button>
            </form>
        </div>

        <div class="import-section">
            <h3>Optional: Import from Environment Variables</h3>
            <p>Load server configuration from Docker environment variables defined in your docker-compose.yml file.</p>
            <form method="POST" action="{{ url_for('settings.import_from_ini') }}">
                <button type="submit" class="btn btn-secondary">Import from Environment</button>
            </form>
            <div class="env-example">
                <h4>Example docker-compose.yml:</h4>
                <pre><code>environment:
  - TAUTULLI_SERVER_A_NAME=MyServer
  - TAUTULLI_SERVER_A_IP=192.168.1.100:8181
  - TAUTULLI_SERVER_A_KEY=your_api_key_here
  # - TAUTULLI_SERVER_A_SSL=false
  # - TAUTULLI_SERVER_A_VERIFY_SSL=false
  # Optional second server:
  # - TAUTULLI_SERVER_B_NAME=Server2
  # - TAUTULLI_SERVER_B_IP=192.168.1.101:8181
  # - TAUTULLI_SERVER_B_KEY=another_api_key
  # - TAUTULLI_SERVER_B_SSL=false
  # - TAUTULLI_SERVER_B_VERIFY_SSL=false</code></pre>
            </div>
        </div>
    </div>

    <div class="settings-right-column">
        <div class="settings-section" id="data-sync-section">
            <h2 class="section-title">
                <svg class="section-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="3" y1="9" x2="21" y2="9"></line>
                    <line x1="9" y1="21" x2="9" y2="9"></line>
                </svg>
                Data Sync
            </h2>

            <div class="form-card">
                <p class="info-text">
                    Run the full data pipeline from one button. This keeps media, history, and lifetime play counts aligned.
                </p>
                <div class="load-process-copy">
                    <p><strong>Step 1:</strong> Import movies and TV shows from each configured server.</p>
                    <p><strong>Step 2:</strong> Import full viewing history from each configured server and then rebuild lifetime play counts so titles with multiple keys are merged correctly.</p>
                </div>

                <!-- Current Status -->
                <div class="history-status" id="history-status">
                    {% if history_stats.total_records > 0 %}
                    <div class="status-info">
                        <div class="status-row">
                            <span class="status-label">Records in database:</span>
                            <span class="status-value">{{ "{:,}".format(history_stats.total_records) }}</span>
                        </div>
                        <div class="status-row">
                            <span class="status-label">Date range ({{ timezone_name }}):</span>
                            <span class="status-value">{{ history_stats.oldest_date }} to {{ history_stats.newest_date }}</span>
                        </div>
                        <div class="status-row">
                            <span class="status-label">Unique users:</span>
                            <span class="status-value">{{ history_stats.unique_users }}</span>
                        </div>
                        <div class="status-row">
                            <span class="status-label">
                                {% if servers %}
                                <button type="button" class="btn-media-refresh" id="media-refresh-btn" title="Refresh media libraries only">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="23 4 23 10 17 10"></polyline>
                                        <polyline points="1 20 1 14 7 14"></polyline>
                                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                                    </svg>
                                </button>
                                {% endif %}
                                Last media sync ({{ timezone_name }}):
                            </span>
                            <span class="status-value" id="last-media-sync-value">{{ media_sync_status.last_sync_date or 'Never' }}</span>
                        </div>
                        <div class="status-row">
                            <span class="status-label">Last full history sync ({{ timezone_name }}):</span>
                            <span class="status-value" id="last-history-sync-value">{{ sync_status.last_sync_date or 'Never' }}</span>
                        </div>
                        <div class="status-row">
                            <span class="status-label">Last lifetime cache build ({{ timezone_name }}):</span>
                            <span class="status-value" id="last-lifetime-sync-value">{{ lifetime_sync_status.last_sync_date or 'Never' }}</span>
                        </div>
                    </div>
                    {% else %}
                    <p class="info-message">No viewing history loaded. Run full data sync to load all media and complete history.</p>
                    {% endif %}
                </div>

                <!-- Step 1 Progress -->
                <div class="sync-progress" id="media-sync-progress" {% if media_sync_status.status != 'running' %}style="display: none;"{% endif %}>
                    <div class="progress-header">
                        <span class="progress-title">Step 1 of 2: Media Library Sync</span>
                    </div>
                    <div id="media-server-progress-container"></div>
                    <div class="progress-stats">
                        <span id="media-progress-fetched">{{ media_sync_status.records_fetched or 0 }}</span> records fetched
                    </div>
                </div>

                <!-- Step 2 Progress -->
                <div class="sync-progress" id="history-sync-progress" {% if sync_status.status != 'running' %}style="display: none;"{% endif %}>
                    <div class="progress-header">
                        <span class="progress-title">Step 2 of 2: Full History Sync</span>
                    </div>
                    <div id="history-server-progress-container"></div>
                    <div class="progress-stats">
                        <span id="progress-fetched">{{ sync_status.records_fetched or 0 }}</span> / <span id="progress-total">{{ sync_status.records_total or '?' }}</span> records
                        (<span id="progress-inserted">{{ sync_status.records_inserted or 0 }}</span> new, <span id="progress-skipped">{{ sync_status.records_skipped or 0 }}</span> duplicates)
                    </div>
                </div>

                <div class="sync-progress" id="lifetime-sync-progress" {% if lifetime_sync_status.status != 'running' %}style="display: none;"{% endif %}>
                    <div class="progress-header">
                        <span class="progress-title">Finalizing: Rebuilding Lifetime Play Count Cache</span>
                    </div>
                    <div id="lifetime-server-progress-container"></div>
                    <div class="progress-stats">
                        <span id="lifetime-progress-fetched">{{ lifetime_sync_status.records_fetched or 0 }}</span> history rows processed
                    </div>
                </div>

                <button type="button" class="btn btn-primary" id="full-sync-btn" {% if not servers %}disabled{% endif %}>
                    {% if media_sync_status.has_data and history_stats.total_records > 0 %}
                    Refresh All Data
                    {% else %}
                    Load All Data
                    {% endif %}
                </button>
                <small class="form-note">
                    {% if servers %}
                    This replaces local media/history data and rebuilds lifetime play-count cache
                    {% else %}
                    Add at least one server configuration before starting a full data sync
                    {% endif %}
                </small>
            </div>
        </div>

    </div>
</div>

<script src="{{ url_for('static', filename='js/progress-renderer.js') }}"></script>
<script>
(function() {
    var mediaStatus = {{ media_sync_status | tojson }};
    var historyStatus = {{ sync_status | tojson }};
    var lifetimeStatus = {{ lifetime_sync_status | tojson }};
    var mediaPollInterval = null;
    var historyPollInterval = null;
    var lifetimePollInterval = null;
    var pipelineInProgress = false;
    var mediaOnlyInProgress = false;
    var hasServerConfig = {{ 'true' if servers else 'false' }};

    function formatTimestampElement(elementId) {
        var element = document.getElementById(elementId);
        if (!element) {
            return;
        }
        var rawValue = (element.textContent || '').trim();
        element.textContent = formatLastUpdatedValue(rawValue);
    }

    function getActionButtonLabel() {
        var hasData = !!(mediaStatus && mediaStatus.has_data) && !!(historyStatus && historyStatus.total_records_in_db > 0);
        return hasData ? 'Refresh All Data' : 'Load All Data';
    }

    function setActionButtonState(disabled, label) {
        var button = document.getElementById('full-sync-btn');
        if (!button) {
            return;
        }
        button.disabled = !hasServerConfig || !!disabled;
        button.textContent = label || getActionButtonLabel();
    }

    function setMediaRefreshState(disabled) {
        var btn = document.getElementById('media-refresh-btn');
        if (btn) {
            btn.disabled = !!disabled;
        }
    }

    var settingsProgressClasses = {
        progress: 'history-server-progress',
        header: 'history-server-header',
        name: 'history-server-name',
        badge: 'history-status-badge',
        step: 'history-server-step',
        bar: 'history-server-bar',
        fill: 'history-server-fill',
        fetched: 'history-server-fetched',
        error: 'history-server-error',
        unitLabel: 'records'
    };

    function renderSettingsServerProgress(containerId, servers, includeHistoryCounts) {
        renderServerProgress(containerId, servers, includeHistoryCounts, settingsProgressClasses);
    }

    function failPipeline(message) {
        mediaPollInterval = stopPoll(mediaPollInterval);
        historyPollInterval = stopPoll(historyPollInterval);
        lifetimePollInterval = stopPoll(lifetimePollInterval);
        pipelineInProgress = false;
        mediaOnlyInProgress = false;
        setActionButtonState(false, getActionButtonLabel());
        setMediaRefreshState(false);
        if (message) {
            alert(message);
        }
    }

    function stopPoll(intervalRef) {
        if (!intervalRef) {
            return null;
        }
        clearInterval(intervalRef);
        return null;
    }

    function updateMediaSyncStatus(status) {
        mediaStatus = status || {};
        var progressDiv = document.getElementById('media-sync-progress');
        var fetchedLabel = document.getElementById('media-progress-fetched');
        var lastSyncLabel = document.getElementById('last-media-sync-value');

        if (status.status === 'running') {
            if (!mediaOnlyInProgress) {
                pipelineInProgress = true;
            }
            progressDiv.style.display = 'block';
            renderSettingsServerProgress('media-server-progress-container', status.servers || [], false);
            if (fetchedLabel) {
                fetchedLabel.textContent = (status.records_fetched || 0).toLocaleString();
            }
            var label = mediaOnlyInProgress ? 'Refreshing Media Libraries...' : 'Step 1/2: Syncing Media...';
            setActionButtonState(true, label);
            setMediaRefreshState(true);
            return;
        }

        progressDiv.style.display = 'none';
        if (lastSyncLabel) {
            lastSyncLabel.textContent = formatLastUpdatedValue(status.last_sync_date);
        }

        mediaPollInterval = stopPoll(mediaPollInterval);

        if (mediaOnlyInProgress) {
            mediaOnlyInProgress = false;
            setActionButtonState(false, getActionButtonLabel());
            setMediaRefreshState(false);
            if (status.status === 'failed') {
                alert('Media sync failed: ' + (status.error_message || 'Unknown error'));
            }
            return;
        }

        if (!pipelineInProgress) {
            setActionButtonState(false, getActionButtonLabel());
            setMediaRefreshState(false);
            return;
        }

        if (status.status === 'success') {
            startHistorySync();
            return;
        }

        if (status.status === 'failed') {
            failPipeline('Media sync failed: ' + (status.error_message || 'Unknown error'));
            return;
        }
    }

    function updateHistorySyncStatus(status) {
        historyStatus = status || {};
        var progressDiv = document.getElementById('history-sync-progress');
        var fetchedLabel = document.getElementById('progress-fetched');
        var totalLabel = document.getElementById('progress-total');
        var insertedLabel = document.getElementById('progress-inserted');
        var skippedLabel = document.getElementById('progress-skipped');
        var lastSyncLabel = document.getElementById('last-history-sync-value');

        if (status.status === 'running') {
            pipelineInProgress = true;
            progressDiv.style.display = 'block';
            renderSettingsServerProgress('history-server-progress-container', status.servers || [], true);
            if (fetchedLabel) fetchedLabel.textContent = (status.records_fetched || 0).toLocaleString();
            if (totalLabel) totalLabel.textContent = status.records_total ? status.records_total.toLocaleString() : '?';
            if (insertedLabel) insertedLabel.textContent = (status.records_inserted || 0).toLocaleString();
            if (skippedLabel) skippedLabel.textContent = (status.records_skipped || 0).toLocaleString();
            setActionButtonState(true, 'Step 2/2: Syncing Full History...');
            return;
        }

        progressDiv.style.display = 'none';
        if (lastSyncLabel) {
            lastSyncLabel.textContent = formatLastUpdatedValue(status.last_sync_date);
        }

        historyPollInterval = stopPoll(historyPollInterval);

        if (!pipelineInProgress) {
            setActionButtonState(false, getActionButtonLabel());
            return;
        }

        if (status.status === 'success') {
            startLifetimeSync();
            return;
        }

        if (status.status === 'failed') {
            failPipeline('History sync failed: ' + (status.error_message || 'Unknown error'));
            return;
        }
    }

    function updateLifetimeSyncStatus(status) {
        lifetimeStatus = status || {};
        var progressDiv = document.getElementById('lifetime-sync-progress');
        var fetchedLabel = document.getElementById('lifetime-progress-fetched');
        var lastSyncLabel = document.getElementById('last-lifetime-sync-value');

        if (status.status === 'running') {
            pipelineInProgress = true;
            progressDiv.style.display = 'block';
            renderSettingsServerProgress('lifetime-server-progress-container', status.servers || [], false);
            if (fetchedLabel) {
                fetchedLabel.textContent = (status.records_fetched || 0).toLocaleString();
            }
            setActionButtonState(true, 'Finalizing: Rebuilding Lifetime Cache...');
            return;
        }

        progressDiv.style.display = 'none';
        if (lastSyncLabel) {
            lastSyncLabel.textContent = formatLastUpdatedValue(status.last_sync_date);
        }

        lifetimePollInterval = stopPoll(lifetimePollInterval);

        if (!pipelineInProgress) {
            setActionButtonState(false, getActionButtonLabel());
            return;
        }

        if (status.status === 'success') {
            window.location.reload();
            return;
        }

        if (status.status === 'failed') {
            failPipeline('Lifetime cache build failed: ' + (status.error_message || 'Unknown error'));
            return;
        }
    }

    function pollMediaStatus() {
        fetch('{{ url_for("main.api_media_status") }}')
            .then(function(response) { return response.json(); })
            .then(function(data) { updateMediaSyncStatus(data); })
            .catch(function(error) { console.error('Error polling media status:', error); });
    }

    function pollHistoryStatus() {
        fetch('{{ url_for("settings.get_history_sync_status") }}')
            .then(function(response) { return response.json(); })
            .then(function(data) { updateHistorySyncStatus(data); })
            .catch(function(error) { console.error('Error polling history status:', error); });
    }

    function pollLifetimeStatus() {
        fetch('{{ url_for("main.api_media_lifetime_stats_status") }}')
            .then(function(response) { return response.json(); })
            .then(function(data) { updateLifetimeSyncStatus(data); })
            .catch(function(error) { console.error('Error polling lifetime status:', error); });
    }

    function startMediaSync() {
        setActionButtonState(true, 'Step 1/2: Syncing Media...');
        fetch('{{ url_for("main.api_media_start_load") }}', { method: 'POST' })
            .then(function(response) {
                return response.json().then(function(payload) {
                    if (!response.ok && response.status !== 409) {
                        throw new Error(payload.error || 'Failed to start media sync');
                    }
                    return payload;
                });
            })
            .then(function() {
                if (!mediaPollInterval) {
                    mediaPollInterval = setInterval(pollMediaStatus, 1000);
                }
                pollMediaStatus();
            })
            .catch(function(error) {
                failPipeline(error.message);
            });
    }

    function startHistorySync() {
        setActionButtonState(true, 'Step 2/2: Syncing Full History...');
        fetch('{{ url_for("settings.start_full_history_backfill") }}', { method: 'POST' })
            .then(function(response) {
                return response.json().then(function(payload) {
                    if (!response.ok && response.status !== 409) {
                        throw new Error(payload.error || 'Failed to start full history sync');
                    }
                    return payload;
                });
            })
            .then(function() {
                if (!historyPollInterval) {
                    historyPollInterval = setInterval(pollHistoryStatus, 1000);
                }
                pollHistoryStatus();
            })
            .catch(function(error) {
                failPipeline(error.message);
            });
    }

    function startLifetimeSync() {
        setActionButtonState(true, 'Finalizing: Rebuilding Lifetime Cache...');
        fetch('{{ url_for("main.api_media_lifetime_stats_start") }}', { method: 'POST' })
            .then(function(response) {
                return response.json().then(function(payload) {
                    if (!response.ok && response.status !== 409) {
                        throw new Error(payload.error || 'Failed to start lifetime cache rebuild');
                    }
                    return payload;
                });
            })
            .then(function() {
                if (!lifetimePollInterval) {
                    lifetimePollInterval = setInterval(pollLifetimeStatus, 1000);
                }
                pollLifetimeStatus();
            })
            .catch(function(error) {
                failPipeline(error.message);
            });
    }

    function startFullPipeline() {
        if (!hasServerConfig) {
            alert('Configure at least one server before running full data sync.');
            return;
        }
        if (pipelineInProgress) {
            return;
        }
        pipelineInProgress = true;
        startMediaSync();
    }

    function startMediaOnlySync() {
        if (!hasServerConfig || pipelineInProgress || mediaOnlyInProgress) {
            return;
        }
        mediaOnlyInProgress = true;
        setActionButtonState(true, 'Refreshing Media Libraries...');
        setMediaRefreshState(true);
        fetch('{{ url_for("main.api_media_start_load") }}', { method: 'POST' })
            .then(function(response) {
                return response.json().then(function(payload) {
                    if (!response.ok && response.status !== 409) {
                        throw new Error(payload.error || 'Failed to start media sync');
                    }
                    return payload;
                });
            })
            .then(function() {
                if (!mediaPollInterval) {
                    mediaPollInterval = setInterval(pollMediaStatus, 1000);
                }
                pollMediaStatus();
            })
            .catch(function(error) {
                mediaOnlyInProgress = false;
                setActionButtonState(false, getActionButtonLabel());
                setMediaRefreshState(false);
                alert(error.message);
            });
    }

    var fullSyncButton = document.getElementById('full-sync-btn');
    if (fullSyncButton) {
        fullSyncButton.addEventListener('click', startFullPipeline);
    }

    var mediaRefreshButton = document.getElementById('media-refresh-btn');
    if (mediaRefreshButton) {
        mediaRefreshButton.addEventListener('click', startMediaOnlySync);
    }

    formatTimestampElement('last-media-sync-value');
    formatTimestampElement('last-history-sync-value');
    formatTimestampElement('last-lifetime-sync-value');

    if (mediaStatus && mediaStatus.status === 'running') {
        pipelineInProgress = true;
        setMediaRefreshState(true);
        if (!mediaPollInterval) {
            mediaPollInterval = setInterval(pollMediaStatus, 1000);
        }
        pollMediaStatus();
        return;
    }

    if (historyStatus && historyStatus.status === 'running') {
        pipelineInProgress = true;
        setMediaRefreshState(true);
        if (!historyPollInterval) {
            historyPollInterval = setInterval(pollHistoryStatus, 1000);
        }
        pollHistoryStatus();
        return;
    }

    if (lifetimeStatus && lifetimeStatus.status === 'running') {
        pipelineInProgress = true;
        setMediaRefreshState(true);
        if (!lifetimePollInterval) {
            lifetimePollInterval = setInterval(pollLifetimeStatus, 1000);
        }
        pollLifetimeStatus();
        return;
    }

    setActionButtonState(false, getActionButtonLabel());
    setMediaRefreshState(false);
})();
</script>

<style>
.history-status {
    margin-bottom: 20px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
}

.status-info {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.status-row {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.status-row:last-child {
    border-bottom: none;
}

.status-label {
    color: #aaa;
}

.status-value {
    color: #f18a3d;
    font-weight: 600;
}

.btn-media-refresh {
    background: none;
    border: 1px solid rgba(241, 138, 61, 0.4);
    border-radius: 4px;
    color: #f18a3d;
    cursor: pointer;
    padding: 2px 6px;
    margin-right: 6px;
    display: inline-flex;
    align-items: center;
    transition: background 0.15s, border-color 0.15s;
}

.btn-media-refresh:hover:not(:disabled) {
    background: rgba(241, 138, 61, 0.15);
    border-color: #f18a3d;
}

.btn-media-refresh:disabled {
    opacity: 0.35;
    cursor: not-allowed;
}

.sync-progress {
    margin-bottom: 20px;
    padding: 20px;
    background: rgba(241, 138, 61, 0.1);
    border: 1px solid rgba(241, 138, 61, 0.3);
    border-radius: 8px;
}

.load-process-copy {
    margin: 0 auto 18px;
    max-width: 700px;
    text-align: left;
    color: #bdbdbd;
    line-height: 1.45;
}

.load-process-copy p {
    margin: 0 0 8px;
}

.progress-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
}

.progress-title {
    font-weight: 600;
    color: #f18a3d;
}

.history-server-progress {
    margin-bottom: 12px;
    padding: 12px;
    background: rgba(0, 0, 0, 0.18);
    border-radius: 8px;
}

.history-server-progress:last-child {
    margin-bottom: 16px;
}

.history-server-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
    margin-bottom: 8px;
}

.history-server-name {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #fff;
    font-weight: 600;
}

.history-status-badge {
    font-size: 0.75em;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 500;
}

.history-status-badge.pending {
    background: rgba(150, 150, 150, 0.3);
    color: #aaa;
}

.history-status-badge.running {
    background: rgba(241, 138, 61, 0.3);
    color: #f18a3d;
}

.history-status-badge.success {
    background: rgba(76, 175, 80, 0.3);
    color: #4caf50;
}

.history-status-badge.failed {
    background: rgba(244, 67, 54, 0.3);
    color: #f44336;
}

.history-server-step {
    color: #f18a3d;
    font-size: 0.85em;
}

.history-server-bar {
    height: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 999px;
    overflow: hidden;
    margin-bottom: 6px;
}

.history-server-fill {
    height: 100%;
    background: linear-gradient(90deg, #f18a3d, #ed542c);
    border-radius: 999px;
    transition: width 0.3s ease;
}

.history-server-fill.success {
    background: linear-gradient(90deg, #4caf50, #45a049);
}

.history-server-fill.failed {
    background: linear-gradient(90deg, #f44336, #d32f2f);
}

.history-server-fetched {
    color: #aaa;
    font-size: 0.8em;
}

.history-server-error {
    margin-top: 4px;
    color: #f44336;
    font-size: 0.8em;
}

.progress-bar-container.large {
    height: 20px;
    margin-bottom: 10px;
}

.progress-stats {
    text-align: center;
    color: #aaa;
    font-size: 0.9em;
}

.form-note {
    display: block;
    margin-top: 10px;
    color: #888;
}

.info-text {
    color: #aaa;
    margin-bottom: 20px;
    line-height: 1.5;
}

.env-example {
    margin-top: 15px;
    padding: 15px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.env-example h4 {
    margin: 0 0 10px 0;
    color: #aaa;
    font-size: 0.9em;
}

.env-example pre {
    margin: 0;
    padding: 12px;
    background: rgba(0, 0, 0, 0.4);
    border-radius: 6px;
    overflow-x: auto;
}

.env-example code {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.85em;
    color: #7cb3f1;
    line-height: 1.6;
}
</style>
{% endblock %}
