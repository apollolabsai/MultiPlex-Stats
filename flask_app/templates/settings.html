{% extends "base.html" %}

{% block title %}Settings - MultiPlex Stats{% endblock %}

{% block content %}
<header>
    <h1 class="settings-title">Settings</h1>
    <div class="subtitle">Configure Your Tautulli Servers & Analytics Preferences</div>
</header>

<div class="settings-container">
    <div class="settings-section">
        <h2 class="section-title">
            <svg class="section-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                <line x1="8" y1="21" x2="16" y2="21"></line>
                <line x1="12" y1="17" x2="12" y2="21"></line>
            </svg>
            Server Configuration
        </h2>

        {% if servers %}
            <div class="server-list">
                {% for server in servers %}
                <div class="server-item">
                    <div class="server-info">
                        <h3>{{ server.name }}</h3>
                        <p>{{ "https" if server.use_ssl else "http" }}://{{ server.ip_address }}</p>
                        <p class="server-meta">Order: {{ "ServerA" if server.server_order == 0 else "ServerB" }}{% if server.use_ssl %} | SSL: ✓{% endif %}</p>
                    </div>
                    <div class="server-actions">
                        <form method="POST" action="{{ url_for('settings.delete_server', server_id=server.id) }}" style="display: inline;">
                            <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this server?');">Delete</button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="info-message">No servers configured. Add your first server below.</p>
        {% endif %}

        <div class="form-card">
            <h3>Add/Update Server</h3>
            <form method="POST" action="{{ url_for('settings.add_server') }}">
                <div class="form-group">
                    <label for="name">Server Name</label>
                    <input type="text" id="name" name="name" required placeholder="e.g., Server1">
                </div>

                <div class="form-group">
                    <label for="ip_address">IP Address:Port</label>
                    <input type="text" id="ip_address" name="ip_address" required placeholder="e.g., 192.168.1.101:8181">
                    <small>Include the port number</small>
                </div>

                <div class="form-group">
                    <label for="api_key">API Key</label>
                    <input type="text" id="api_key" name="api_key" required placeholder="Your Tautulli API key">
                    <small>Find in Tautulli: Settings → Web Interface → API</small>
                </div>

                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" id="use_ssl" name="use_ssl" value="1">
                        Use HTTPS/SSL
                    </label>
                    <small>Check this if your Tautulli server uses HTTPS</small>
                </div>

                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" id="verify_ssl" name="verify_ssl" value="1">
                        Verify SSL Certificate
                    </label>
                    <small>Check this only if using HTTPS with a valid certificate</small>
                </div>

                <div class="form-group">
                    <label for="server_order">Server Order</label>
                    <select id="server_order" name="server_order">
                        <option value="0">Server A (Primary)</option>
                        <option value="1">Server B (Secondary)</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary">Save Server</button>
            </form>
        </div>

        <div class="import-section">
            <h3>Optional: Import from Environment Variables</h3>
            <p>Load server configuration from Docker environment variables defined in your docker-compose.yml file.</p>
            <form method="POST" action="{{ url_for('settings.import_from_ini') }}">
                <button type="submit" class="btn btn-secondary">Import from Environment</button>
            </form>
            <div class="env-example">
                <h4>Example docker-compose.yml:</h4>
                <pre><code>environment:
  - TAUTULLI_SERVER_A_NAME=MyServer
  - TAUTULLI_SERVER_A_IP=192.168.1.100:8181
  - TAUTULLI_SERVER_A_KEY=your_api_key_here
  # - TAUTULLI_SERVER_A_SSL=false
  # - TAUTULLI_SERVER_A_VERIFY_SSL=false
  # Optional second server:
  # - TAUTULLI_SERVER_B_NAME=Server2
  # - TAUTULLI_SERVER_B_IP=192.168.1.101:8181
  # - TAUTULLI_SERVER_B_KEY=another_api_key
  # - TAUTULLI_SERVER_B_SSL=false
  # - TAUTULLI_SERVER_B_VERIFY_SSL=false</code></pre>
            </div>
        </div>
    </div>

    <div class="settings-right-column">
        <div class="settings-section">
            <h2 class="section-title">
                <svg class="section-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="3" y1="9" x2="21" y2="9"></line>
                    <line x1="9" y1="21" x2="9" y2="9"></line>
                </svg>
                Import Viewing History
            </h2>

            <div class="form-card">
                <p class="info-text">
                    Load viewing history from Tautulli into a local database for fast display in the dashboard.
                    This is typically a one-time load; new records are automatically appended when you refresh the dashboard.
                </p>

                <!-- Current Status -->
                <div class="history-status" id="history-status">
                    {% if history_stats.total_records > 0 %}
                    <div class="status-info">
                        <div class="status-row">
                            <span class="status-label">Records in database:</span>
                            <span class="status-value">{{ "{:,}".format(history_stats.total_records) }}</span>
                        </div>
                        <div class="status-row">
                            <span class="status-label">Date range ({{ timezone_name }}):</span>
                            <span class="status-value">{{ history_stats.oldest_date }} to {{ history_stats.newest_date }}</span>
                        </div>
                        <div class="status-row">
                            <span class="status-label">Unique users:</span>
                            <span class="status-value">{{ history_stats.unique_users }}</span>
                        </div>
                        {% if sync_status.last_sync_date %}
                        <div class="status-row">
                            <span class="status-label">Last synced ({{ timezone_name }}):</span>
                            <span class="status-value">{{ sync_status.last_sync_date }}</span>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <p class="info-message">No viewing history loaded. Use the form below to load history data.</p>
                    {% endif %}
                </div>

                <!-- Sync Progress (shown when running) -->
                <div class="sync-progress" id="sync-progress" style="display: none;">
                    <div class="progress-header">
                        <span class="progress-title">Loading history...</span>
                    </div>
                    <div id="history-server-progress-container"></div>
                    <div class="progress-bar-container large">
                        <div class="progress-bar-fill orange" id="progress-bar" style="width: 0%;"></div>
                    </div>
                    <div class="progress-stats">
                        <span id="progress-fetched">0</span> / <span id="progress-total">?</span> records
                        (<span id="progress-inserted">0</span> new, <span id="progress-skipped">0</span> duplicates)
                    </div>
                </div>

                <!-- Load History Form -->
                <form method="POST" action="{{ url_for('settings.start_history_backfill') }}" id="backfill-form">
                    <div class="form-group">
                        <label for="backfill_days">Days of History to Load</label>
                        <input type="number" id="backfill_days" name="backfill_days"
                               value="{{ settings.history_backfill_days if settings else 365 }}" min="1" max="3650">
                        <small>Loading more days takes longer but provides more data for the Viewing History table</small>
                    </div>

                    <button type="submit" class="btn btn-primary" id="backfill-btn">
                        {% if history_stats.total_records > 0 %}
                        Reload History Data
                        {% else %}
                        Load History Data
                        {% endif %}
                    </button>
                    <small class="form-note">This will replace any existing history data</small>
                </form>
            </div>
        </div>

    </div>
</div>

<script>
// Poll for sync status when a sync is running
(function() {
    var pollInterval = null;
    var syncStatus = {{ sync_status | tojson }};

    function renderServerProgress(servers) {
        var container = document.getElementById('history-server-progress-container');
        if (!container) {
            return;
        }

        var html = '';
        (servers || []).forEach(function(server) {
            var percent = 0;
            if (server.total && server.total > 0) {
                percent = Math.min(100, (server.fetched / server.total) * 100);
            } else if (server.status === 'success') {
                percent = 100;
            }

            var fillClass = '';
            if (server.status === 'success') fillClass = 'success';
            else if (server.status === 'failed') fillClass = 'failed';

            html += '<div class="history-server-progress">';
            html += '<div class="history-server-header">';
            html += '<span class="history-server-name">' + (server.name || 'Server');
            html += '<span class="history-status-badge ' + (server.status || 'idle') + '">' + (server.status || 'idle') + '</span>';
            html += '</span>';
            html += '<span class="history-server-step">' + (server.step || '') + '</span>';
            html += '</div>';
            html += '<div class="history-server-bar">';
            html += '<div class="history-server-fill ' + fillClass + '" style="width: ' + percent + '%;"></div>';
            html += '</div>';
            html += '<div class="history-server-fetched">' + ((server.fetched || 0).toLocaleString()) + ' records';
            if (server.total) {
                html += ' / ' + server.total.toLocaleString() + ' total';
            }
            html += ' (' + ((server.inserted || 0).toLocaleString()) + ' new, ' + ((server.skipped || 0).toLocaleString()) + ' duplicates)</div>';
            if (server.error) {
                html += '<div class="history-server-error">' + server.error + '</div>';
            }
            html += '</div>';
        });
        container.innerHTML = html;
    }

    function updateProgress(status) {
        var progressDiv = document.getElementById('sync-progress');
        var backfillBtn = document.getElementById('backfill-btn');

        if (status.status === 'running') {
            progressDiv.style.display = 'block';
            backfillBtn.disabled = true;
            backfillBtn.textContent = 'Loading...';

            // Update progress
            renderServerProgress(status.servers || []);
            document.getElementById('progress-fetched').textContent = status.records_fetched.toLocaleString();
            document.getElementById('progress-total').textContent = status.records_total ? status.records_total.toLocaleString() : '?';
            document.getElementById('progress-inserted').textContent = status.records_inserted.toLocaleString();
            document.getElementById('progress-skipped').textContent = status.records_skipped.toLocaleString();

            // Update progress bar
            if (status.records_total && status.records_total > 0) {
                var percent = Math.min(100, (status.records_fetched / status.records_total) * 100);
                document.getElementById('progress-bar').style.width = percent + '%';
            }
        } else {
            progressDiv.style.display = 'none';
            backfillBtn.disabled = false;
            backfillBtn.textContent = status.total_records_in_db > 0 ? 'Reload History Data' : 'Load History Data';
            renderServerProgress(status.servers || []);

            if (status.status === 'success') {
                // Reload page to show updated stats
                window.location.reload();
            } else if (status.status === 'failed' && status.error_message) {
                alert('Sync failed: ' + status.error_message);
            }

            // Stop polling
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }
    }

    function pollStatus() {
        fetch('{{ url_for("settings.get_history_sync_status") }}')
            .then(function(response) { return response.json(); })
            .then(function(data) { updateProgress(data); })
            .catch(function(error) { console.error('Error polling status:', error); });
    }

    // Start polling if sync is running
    if (syncStatus.status === 'running') {
        updateProgress(syncStatus);
        pollInterval = setInterval(pollStatus, 1000);
    }

    // Also start polling when form is submitted
    document.getElementById('backfill-form').addEventListener('submit', function() {
        setTimeout(function() {
            pollInterval = setInterval(pollStatus, 1000);
        }, 500);
    });
})();
</script>

<style>
.history-status {
    margin-bottom: 20px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
}

.status-info {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.status-row {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.status-row:last-child {
    border-bottom: none;
}

.status-label {
    color: #aaa;
}

.status-value {
    color: #f18a3d;
    font-weight: 600;
}

.sync-progress {
    margin-bottom: 20px;
    padding: 20px;
    background: rgba(241, 138, 61, 0.1);
    border: 1px solid rgba(241, 138, 61, 0.3);
    border-radius: 8px;
}

.progress-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
}

.progress-title {
    font-weight: 600;
    color: #f18a3d;
}

.history-server-progress {
    margin-bottom: 12px;
    padding: 12px;
    background: rgba(0, 0, 0, 0.18);
    border-radius: 8px;
}

.history-server-progress:last-child {
    margin-bottom: 16px;
}

.history-server-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
    margin-bottom: 8px;
}

.history-server-name {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #fff;
    font-weight: 600;
}

.history-status-badge {
    font-size: 0.75em;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 500;
}

.history-status-badge.pending {
    background: rgba(150, 150, 150, 0.3);
    color: #aaa;
}

.history-status-badge.running {
    background: rgba(241, 138, 61, 0.3);
    color: #f18a3d;
}

.history-status-badge.success {
    background: rgba(76, 175, 80, 0.3);
    color: #4caf50;
}

.history-status-badge.failed {
    background: rgba(244, 67, 54, 0.3);
    color: #f44336;
}

.history-server-step {
    color: #f18a3d;
    font-size: 0.85em;
}

.history-server-bar {
    height: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 999px;
    overflow: hidden;
    margin-bottom: 6px;
}

.history-server-fill {
    height: 100%;
    background: linear-gradient(90deg, #f18a3d, #ed542c);
    border-radius: 999px;
    transition: width 0.3s ease;
}

.history-server-fill.success {
    background: linear-gradient(90deg, #4caf50, #45a049);
}

.history-server-fill.failed {
    background: linear-gradient(90deg, #f44336, #d32f2f);
}

.history-server-fetched {
    color: #aaa;
    font-size: 0.8em;
}

.history-server-error {
    margin-top: 4px;
    color: #f44336;
    font-size: 0.8em;
}

.progress-bar-container.large {
    height: 20px;
    margin-bottom: 10px;
}

.progress-stats {
    text-align: center;
    color: #aaa;
    font-size: 0.9em;
}

.form-note {
    display: block;
    margin-top: 10px;
    color: #888;
}

.info-text {
    color: #aaa;
    margin-bottom: 20px;
    line-height: 1.5;
}

.env-example {
    margin-top: 15px;
    padding: 15px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.env-example h4 {
    margin: 0 0 10px 0;
    color: #aaa;
    font-size: 0.9em;
}

.env-example pre {
    margin: 0;
    padding: 12px;
    background: rgba(0, 0, 0, 0.4);
    border-radius: 6px;
    overflow-x: auto;
}

.env-example code {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.85em;
    color: #7cb3f1;
    line-height: 1.6;
}
</style>
{% endblock %}
