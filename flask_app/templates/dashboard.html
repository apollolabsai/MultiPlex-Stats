{% extends "base.html" %}

{% block title %}Dashboard - MultiPlex Stats{% endblock %}

{% block content %}
{% if not has_data %}
<header>
    <img src="{{ url_for('static', filename='logo.png') }}" alt="MultiPlex Stats" style="max-width: 400px; height: auto; margin-bottom: 10px;">
    <div class="subtitle">Web Interface for Tautulli Analytics</div>
</header>

{% if not has_config %}
<div class="welcome-card">
    <h2>Welcome to MultiPlex Stats!</h2>
    <p>Get started by configuring your Tautulli server connection.</p>
    <a href="{{ url_for('settings.index') }}" class="btn btn-primary btn-large">
        <img class="button-icon" src="{{ url_for('static', filename='gear.png') }}" alt="" width="20" height="20">
        Go to Settings
    </a>
</div>
{% else %}
<div class="action-card">
    <h2>Run Analytics</h2>
    <p>Execute analytics on your configured Tautulli servers.</p>

    {% if servers %}
    <div class="server-status">
        <h3>Configured Servers:</h3>
        <ul>
            {% for server in servers %}
            <li>{{ server.name }} ({{ server.ip_address }})</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <form method="POST" action="{{ url_for('main.run_analytics') }}">
        <button type="submit" class="btn btn-success btn-large analytics-refresh-btn" data-hover-help="Runs analytics across your configured servers, refreshes dashboard charts, and updates Viewing History with new records.">
            <svg class="button-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#4CAF50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
            </svg>
            Run Analytics
        </button>
    </form>
</div>

{% if last_run %}
<div class="status-card">
    <h2>Last Run Status</h2>
    <div class="status-info">
        <p><strong>Status:</strong>
            {% if last_run.status == 'success' %}
                <span class="badge badge-success">✓ Success</span>
            {% elif last_run.status == 'failed' %}
                <span class="badge badge-error">✗ Failed</span>
            {% else %}
                <span class="badge badge-info">⟳ Running</span>
            {% endif %}
        </p>
        <p><strong>Started ({{ timezone_name }}):</strong> {{ last_run.started_at | datetime_to_local }}</p>
        {% if last_run.completed_at %}
        <p><strong>Completed ({{ timezone_name }}):</strong> {{ last_run.completed_at | datetime_to_local }}</p>
        {% endif %}

        {% if last_run.status == 'success' %}
        <p><strong>Total Plays:</strong> {{ "{:,}".format(last_run.total_plays) }}</p>
        <p><strong>Active Users:</strong> {{ last_run.total_users }}</p>
        {% endif %}

        {% if last_run.status == 'failed' and last_run.error_message %}
        <div class="error-message">
            <strong>Error:</strong> {{ last_run.error_message }}
        </div>
        {% endif %}
    </div>
</div>
{% endif %}
{% endif %}

<div class="info-section">
    <h2>About MultiPlex Stats</h2>
    <p>MultiPlex Stats provides comprehensive analytics for your Plex Media Server using Tautulli data.</p>
    <ul>
        <li>Track viewing trends over time</li>
        <li>Identify your most active users</li>
        <li>Discover your most popular content</li>
        <li>Compare statistics across multiple servers</li>
        <li>Beautiful interactive charts powered by Highcharts</li>
    </ul>
</div>
{% else %}
<header class="dashboard-hero" id="dashboard-hero">
    <div class="dashboard-hero-backdrop" id="dashboard-hero-backdrop" aria-hidden="true"></div>
    <div class="dashboard-hero-overlay" aria-hidden="true"></div>
    <div class="dashboard-hero-content">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="MultiPlex Stats" style="max-width: 400px; height: auto; margin-bottom: 10px;">
        <div class="subtitle">Plex Server Analytics & Insights</div>
        <div class="timestamp">
            Generated: {{ completed_at_pt.strftime('%Y-%m-%d %I:%M:%S %p') }} ({{ timezone_name }})
        </div>

        <form method="POST" action="{{ url_for('main.run_analytics') }}" style="margin-top: 20px;">
            <button type="submit" class="btn btn-primary btn-large analytics-refresh-btn" data-hover-help="Runs analytics across your configured servers, refreshes dashboard charts, and updates Viewing History with new records.">
                <svg class="button-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                </svg>
                Refresh Analytics
            </button>
        </form>
    </div>
</header>

<div class="section">
    <h2 class="section-title">
        <svg class="section-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
        </svg>
        Currently Streaming
    </h2>
    <div class="current-activity-controls">
        <label class="current-activity-refresh">
            Refresh every
            <input type="number" id="current-activity-refresh-minutes" class="current-activity-refresh-input" min="1" step="1" value="5">
            Minutes
        </label>
        <div class="current-activity-last-updated" id="current-activity-last-updated">Last Updated: just now</div>
    </div>
    <div class="table-container" style="overflow: visible;">
        <div id="current-activity-container">
            {% include 'partials/current_activity.html' %}
        </div>
    </div>
</div>

<div class="section">
    <h2 class="section-title">
        <svg class="section-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="20" x2="18" y2="10"></line>
            <line x1="12" y1="20" x2="12" y2="4"></line>
            <line x1="6" y1="20" x2="6" y2="14"></line>
        </svg>
        Activity Trends
    </h2>
    <div class="chart-controls">
        <div class="chart-controls-label">Filter by user</div>
        <select id="activity-user-filter" class="user-filter-select">
            <option value="">All Users</option>
            <!-- Options populated via JavaScript -->
        </select>
    </div>
    <div class="chart-controls">
        <div class="chart-controls-label">Daily range</div>
        <form class="chart-controls-form" id="daily-range-form">
            <div class="chart-controls-group">
                <button type="button" data-days="7" class="range-pill {% if summary.daily_trend_days == 7 %}active{% endif %}">7d</button>
                <button type="button" data-days="30" class="range-pill {% if summary.daily_trend_days == 30 %}active{% endif %}">30d</button>
                <button type="button" data-days="60" class="range-pill {% if summary.daily_trend_days == 60 %}active{% endif %}">60d</button>
                <button type="button" data-days="90" class="range-pill {% if summary.daily_trend_days == 90 %}active{% endif %}">90d</button>
                <div class="range-custom">
                    <input type="number" name="daily_trend_days_custom" min="1" max="3650" placeholder="Custom days"
                           value="{% if summary.daily_trend_days not in [7, 30, 60, 90] %}{{ summary.daily_trend_days }}{% endif %}">
                    <button type="button" class="range-pill range-apply">Apply</button>
                </div>
            </div>
        </form>
    </div>
    <div class="chart-container" id="daily-chart-container">
        <!-- Chart rendered by Highcharts -->
    </div>
    <div class="chart-controls">
        <div class="chart-controls-label">Monthly range</div>
        <form class="chart-controls-form" id="monthly-range-form">
            <div class="chart-controls-group">
                <button type="button" data-months="12" class="range-pill {% if summary.monthly_trend_months == 12 %}active{% endif %}">1y</button>
                <button type="button" data-months="24" class="range-pill {% if summary.monthly_trend_months == 24 %}active{% endif %}">2y</button>
                <button type="button" data-months="60" class="range-pill {% if summary.monthly_trend_months == 60 %}active{% endif %}">5y</button>
                <button type="button" data-months="120" class="range-pill {% if summary.monthly_trend_months == 120 %}active{% endif %}">10y</button>
                <div class="range-custom">
                    <input type="number" name="monthly_trend_months_custom" min="1" max="120" placeholder="Custom months"
                           value="{% if summary.monthly_trend_months not in [12, 24, 60, 120] %}{{ summary.monthly_trend_months }}{% endif %}">
                    <button type="button" class="range-pill range-apply-monthly">Apply</button>
                </div>
            </div>
        </form>
    </div>
    <div class="chart-container" id="monthly-chart-container">
        <!-- Chart rendered by Highcharts -->
    </div>
    <div class="chart-controls">
        <div class="chart-controls-label">Concurrent streams range</div>
        <form class="chart-controls-form" id="concurrent-range-form">
            <div class="chart-controls-group">
                <button type="button" data-days="7" class="range-pill">7d</button>
                <button type="button" data-days="30" class="range-pill">30d</button>
                <button type="button" data-days="60" class="range-pill active">60d</button>
                <button type="button" data-days="90" class="range-pill">90d</button>
                <div class="range-custom">
                    <input type="number" name="concurrent_days_custom" min="1" max="3650" placeholder="Custom days">
                    <button type="button" class="range-pill range-apply-concurrent">Apply</button>
                </div>
            </div>
        </form>
    </div>
    <div class="chart-container" id="concurrent-chart-container">
        <!-- Chart rendered by Highcharts -->
    </div>
</div>

<div class="section">
    <h2 class="section-title">
        <svg class="section-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path>
            <path d="M22 12A10 10 0 0 0 12 2v10z"></path>
        </svg>
        Distribution
    </h2>
    <div class="chart-controls">
        <div class="chart-controls-label">Distribution range</div>
        <form class="chart-controls-form" id="distribution-range-form">
            <div class="chart-controls-group">
                <button type="button" data-days="7" class="range-pill {% if summary.distribution_days == 7 %}active{% endif %}">7d</button>
                <button type="button" data-days="30" class="range-pill {% if summary.distribution_days == 30 %}active{% endif %}">30d</button>
                <button type="button" data-days="60" class="range-pill {% if summary.distribution_days == 60 %}active{% endif %}">60d</button>
                <button type="button" data-days="90" class="range-pill {% if summary.distribution_days == 90 %}active{% endif %}">90d</button>
                <div class="range-custom">
                    <input type="number" name="distribution_days_custom" min="1" max="3650" placeholder="Custom days"
                           value="{% if summary.distribution_days not in [7, 30, 60, 90] %}{{ summary.distribution_days }}{% endif %}">
                    <button type="button" class="range-pill range-apply-distribution">Apply</button>
                </div>
            </div>
        </form>
    </div>
    <div class="grid-3">
        <div class="chart-container" id="distribution-category-container">
            <!-- Chart rendered by Highcharts -->
        </div>
        <div class="chart-container" id="distribution-server-container">
            <!-- Chart rendered by Highcharts -->
        </div>
        <div class="chart-container" id="distribution-platform-container">
            <!-- Chart rendered by Highcharts -->
        </div>
    </div>
</div>

<div class="section">
    <h2 class="section-title">
        <svg class="section-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
        </svg>
        User Activity
    </h2>
    <div class="chart-controls">
        <div class="chart-controls-label">Top <input type="number" class="top-n-input" id="user-top-n" min="1" max="100" value="{{ summary.top_users|default(20) }}"> Users</div>
        <form class="chart-controls-form" id="user-range-form">
            <div class="chart-controls-group">
                <button type="button" data-days="7" class="range-pill {% if summary.user_chart_days == 7 %}active{% endif %}">7d</button>
                <button type="button" data-days="30" class="range-pill {% if summary.user_chart_days == 30 %}active{% endif %}">30d</button>
                <button type="button" data-days="60" class="range-pill {% if summary.user_chart_days == 60 %}active{% endif %}">60d</button>
                <button type="button" data-days="90" class="range-pill {% if summary.user_chart_days == 90 %}active{% endif %}">90d</button>
                <div class="range-custom">
                    <input type="number" name="user_days_custom" min="1" max="3650" placeholder="Custom days"
                           value="{% if summary.user_chart_days not in [7, 30, 60, 90] %}{{ summary.user_chart_days }}{% endif %}">
                    <button type="button" class="range-pill range-apply-user">Apply</button>
                </div>
            </div>
        </form>
    </div>
    <div class="chart-container" id="user-chart-container">
        <!-- Chart rendered by Highcharts -->
    </div>
</div>

<div class="section">
    <h2 class="section-title">
        <svg class="section-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
            <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
            <path d="M4 22h16"></path>
            <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path>
            <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path>
            <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path>
        </svg>
        Top Content
    </h2>
    <div class="chart-controls">
        <div class="chart-controls-label">Top <input type="number" class="top-n-input" id="movie-top-n" min="1" max="100" value="{{ summary.top_movies|default(30) }}"> Movies</div>
        <form class="chart-controls-form" id="movie-range-form">
            <div class="chart-controls-group">
                <button type="button" data-days="7" class="range-pill {% if summary.movie_chart_days == 7 %}active{% endif %}">7d</button>
                <button type="button" data-days="30" class="range-pill {% if summary.movie_chart_days == 30 %}active{% endif %}">30d</button>
                <button type="button" data-days="60" class="range-pill {% if summary.movie_chart_days == 60 %}active{% endif %}">60d</button>
                <button type="button" data-days="90" class="range-pill {% if summary.movie_chart_days == 90 %}active{% endif %}">90d</button>
                <div class="range-custom">
                    <input type="number" name="movie_days_custom" min="1" max="3650" placeholder="Custom days"
                           value="{% if summary.movie_chart_days not in [7, 30, 60, 90] %}{{ summary.movie_chart_days }}{% endif %}">
                    <button type="button" class="range-pill range-apply-movie">Apply</button>
                </div>
            </div>
        </form>
    </div>
    <div class="chart-container" id="movie-chart-container">
        <!-- Chart rendered by Highcharts -->
    </div>
    <div class="chart-controls">
        <div class="chart-controls-label">Top <input type="number" class="top-n-input" id="tv-top-n" min="1" max="100" value="{{ summary.top_tv_shows|default(30) }}"> TV Shows</div>
        <form class="chart-controls-form" id="tv-range-form">
            <div class="chart-controls-group">
                <button type="button" data-days="7" class="range-pill {% if summary.tv_chart_days == 7 %}active{% endif %}">7d</button>
                <button type="button" data-days="30" class="range-pill {% if summary.tv_chart_days == 30 %}active{% endif %}">30d</button>
                <button type="button" data-days="60" class="range-pill {% if summary.tv_chart_days == 60 %}active{% endif %}">60d</button>
                <button type="button" data-days="90" class="range-pill {% if summary.tv_chart_days == 90 %}active{% endif %}">90d</button>
                <div class="range-custom">
                    <input type="number" name="tv_days_custom" min="1" max="3650" placeholder="Custom days"
                           value="{% if summary.tv_chart_days not in [7, 30, 60, 90] %}{{ summary.tv_chart_days }}{% endif %}">
                    <button type="button" class="range-pill range-apply-tv">Apply</button>
                </div>
            </div>
        </form>
    </div>
    <div class="chart-container" id="tv-chart-container">
        <!-- Chart rendered by Highcharts -->
    </div>
</div>

<div class="nav-loading-overlay" id="nav-loading-overlay" aria-hidden="true">
    <div class="nav-loading-card" role="status" aria-live="polite">
        <div class="nav-loading-title" id="nav-loading-title">Loading content details...</div>
        <div class="nav-loading-subtitle" id="nav-loading-subtitle">Please wait</div>
        <div class="nav-loading-bar-track">
            <div class="nav-loading-bar-fill"></div>
        </div>
    </div>
</div>

{% endif %}
{% endblock %}

{% block scripts %}
{% if has_data %}
<!-- jQuery for DOM manipulation -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<!-- Highcharts rendering functions -->
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>

<style>
/* Poster preview on hover */
.title-with-preview {
    position: relative;
    display: inline-block;
    cursor: pointer;
}

.title-with-preview .content-title {
    text-decoration: underline;
    text-decoration-style: dotted;
    text-decoration-color: #f18a3d;
}

.content-link {
    color: #f18a3d;
    text-decoration: none;
    border-bottom: 1px dotted rgba(241, 138, 61, 0.6);
}

.content-link:hover {
    color: #ffaf6e;
}

.dashboard-hero {
    position: relative;
    overflow: hidden;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    background: #171717;
}

.dashboard-hero-backdrop {
    position: absolute;
    inset: 0;
    opacity: 0.7;
    display: grid;
    grid-auto-flow: column;
    align-content: start;
    justify-content: start;
}

.dashboard-hero-tile {
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
}

.dashboard-hero-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(10, 10, 10, 0.9) 0%, rgba(14, 14, 14, 0.68) 55%, rgba(12, 12, 12, 0.86) 100%);
}

.dashboard-hero-content {
    position: relative;
    z-index: 2;
}

.button-help-tooltip {
    position: fixed;
    z-index: 14000;
    max-width: 320px;
    padding: 8px 10px;
    border-radius: 8px;
    border: 1px solid rgba(241, 138, 61, 0.4);
    background: rgba(12, 12, 12, 0.96);
    color: #f7f7f7;
    font-size: 0.84em;
    line-height: 1.35;
    box-shadow: 0 10px 24px rgba(0, 0, 0, 0.45);
    pointer-events: none;
    opacity: 0;
    transform: translateY(4px);
    transition: opacity 0.14s ease, transform 0.14s ease;
}

.button-help-tooltip.is-visible {
    opacity: 1;
    transform: translateY(0);
}

.poster-preview {
    display: none;
    position: fixed;
    z-index: 10000;
    background: #1a1a1a;
    border: 2px solid #f18a3d;
    border-radius: 8px;
    padding: 5px;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.8);
    pointer-events: none;
}

.poster-preview img {
    display: block;
    width: 150px;
    height: 225px;
    object-fit: cover;
    border-radius: 4px;
}

/* Current activity controls */
.current-activity-controls {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 12px;
}

.current-activity-refresh {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: #bdbdbd;
    font-size: 0.95em;
}

.current-activity-refresh-input {
    width: 60px;
    padding: 4px 6px;
    border-radius: 6px;
    border: 1px solid rgba(255, 255, 255, 0.15);
    background: rgba(0, 0, 0, 0.3);
    color: #f18a3d;
    font-weight: 600;
    font-size: 0.95em;
    text-align: center;
}

.current-activity-last-updated {
    color: #888;
    font-size: 0.9em;
}

.nav-loading-overlay {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.6);
    z-index: 13000;
    backdrop-filter: blur(2px);
}

.nav-loading-overlay.is-open {
    display: flex;
}

.nav-loading-card {
    width: min(420px, 86vw);
    background: #1b1b1b;
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 24px 60px rgba(0, 0, 0, 0.45);
}

.nav-loading-title {
    color: #fff;
    font-size: 1.02em;
    font-weight: 600;
}

.nav-loading-subtitle {
    margin-top: 4px;
    color: #bdbdbd;
    font-size: 0.9em;
}

.nav-loading-bar-track {
    margin-top: 14px;
    width: 100%;
    height: 4px;
    border-radius: 999px;
    overflow: hidden;
    background: rgba(255, 255, 255, 0.12);
}

.nav-loading-bar-fill {
    width: 38%;
    height: 100%;
    background: linear-gradient(90deg, #e6b413 0%, #f18a3d 70%, #ed542c 100%);
    border-radius: 999px;
    animation: nav-loading-slide 1.1s ease-in-out infinite;
}

@keyframes nav-loading-slide {
    0% {
        transform: translateX(-120%);
    }
    100% {
        transform: translateX(280%);
    }
}

/* Chart range controls */
.chart-controls {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 12px;
}

.chart-controls-label {
    font-size: 0.95em;
    color: #bdbdbd;
    text-transform: uppercase;
    letter-spacing: 0.08em;
}

.chart-controls-form {
    width: 100%;
}

.chart-controls-group {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
}

.range-pill {
    border: 0;
    padding: 8px 14px;
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.08);
    color: #fff;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s ease, transform 0.2s ease;
}

.range-pill:hover {
    background: rgba(255, 255, 255, 0.14);
    transform: translateY(-1px);
}

.range-pill.active {
    background: #f18a3d;
    color: #111;
}

.range-custom {
    display: flex;
    align-items: center;
    gap: 8px;
}

.range-custom input {
    width: 140px;
    padding: 8px 10px;
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.15);
    background: rgba(0, 0, 0, 0.3);
    color: #fff;
}

.chart-container.is-loading {
    opacity: 0.6;
    pointer-events: none;
}

.top-n-input {
    width: 50px;
    padding: 4px 6px;
    margin: 0 4px;
    border-radius: 6px;
    border: 1px solid rgba(255, 255, 255, 0.15);
    background: rgba(0, 0, 0, 0.3);
    color: #f18a3d;
    font-weight: 600;
    font-size: 0.95em;
    text-align: center;
}

.user-filter-select {
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.15);
    background: rgba(0, 0, 0, 0.3);
    color: #fff;
    font-size: 0.95em;
    min-width: 200px;
    cursor: pointer;
}

.user-filter-select:focus {
    outline: none;
    border-color: #f18a3d;
}

.user-filter-select option {
    background: #1a1a1a;
    color: #fff;
}

@media (min-width: 900px) {
    .chart-controls-form {
        width: auto;
    }
}
</style>

<script>
$(document).ready(function() {
    var refreshTimer = null;
    var lastUpdatedTimer = null;
    var lastActivityUpdateAt = Date.now();
    var posterPreviewBound = false;
    var navigationInProgress = false;
    var analyticsRefreshInProgress = false;
    var refreshHelpTooltipEl = null;
    var refreshHelpHoverTimer = null;
    var refreshHelpTargetEl = null;
    var dashboardHeroRows = 3;
    var dashboardHeroGap = 2;
    var dashboardHeroOverflowColumns = 3;
    var dashboardHeroPosters = [];
    var dashboardHeroBackdrop = document.getElementById('dashboard-hero-backdrop');
    var dashboardHeroElement = document.getElementById('dashboard-hero');
    var dashboardHeroResizeTimer = null;

    function calculateDashboardHeroQuiltLayout() {
        if (!dashboardHeroBackdrop || !dashboardHeroElement) {
            return null;
        }

        var heroHeight = Math.max(186, dashboardHeroElement.clientHeight || 0);
        var heroWidth = Math.max(320, dashboardHeroElement.clientWidth || 0);
        var tileHeight = Math.max(60, Math.floor((heroHeight - dashboardHeroGap * (dashboardHeroRows - 1)) / dashboardHeroRows));
        var tileWidth = Math.max(40, Math.round(tileHeight * (2 / 3))); // poster ratio 2:3
        var columns = Math.max(1, Math.ceil(heroWidth / (tileWidth + dashboardHeroGap)) + dashboardHeroOverflowColumns);

        return {
            rows: dashboardHeroRows,
            gap: dashboardHeroGap,
            tileHeight: tileHeight,
            tileWidth: tileWidth,
            columns: columns,
            tileCount: columns * dashboardHeroRows
        };
    }

    function renderDashboardHeroPosters(posters) {
        if (!dashboardHeroBackdrop) {
            return;
        }

        dashboardHeroBackdrop.innerHTML = '';
        if (!Array.isArray(posters) || posters.length === 0) {
            return;
        }

        var normalizedPosters = posters.filter(function(item) {
            return item && item.poster_url;
        });
        if (normalizedPosters.length === 0) {
            return;
        }

        var layout = calculateDashboardHeroQuiltLayout();
        if (!layout) {
            return;
        }

        dashboardHeroBackdrop.style.gridTemplateRows = 'repeat(' + layout.rows + ', ' + layout.tileHeight + 'px)';
        dashboardHeroBackdrop.style.gridAutoColumns = layout.tileWidth + 'px';
        dashboardHeroBackdrop.style.rowGap = layout.gap + 'px';
        dashboardHeroBackdrop.style.columnGap = layout.gap + 'px';

        for (var i = 0; i < layout.tileCount; i++) {
            var item = normalizedPosters[i % normalizedPosters.length];
            var posterUrl = String(item.poster_url || '').replace(/"/g, '\\"');
            var tile = document.createElement('div');
            tile.className = 'dashboard-hero-tile';
            tile.style.backgroundImage = 'url("' + posterUrl + '")';
            if (item.title) {
                tile.setAttribute('title', item.title);
            }
            dashboardHeroBackdrop.appendChild(tile);
        }
    }

    function loadDashboardHeroPosters() {
        fetch('{{ url_for("main.api_dashboard_top_posters") }}')
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('Failed to load dashboard hero posters.');
                }
                return response.json();
            })
            .then(function(payload) {
                dashboardHeroPosters = Array.isArray(payload.posters) ? payload.posters : [];
                renderDashboardHeroPosters(dashboardHeroPosters);
            })
            .catch(function(error) {
                console.error('Error loading dashboard hero posters:', error);
            });
    }

    function scheduleDashboardHeroRerender() {
        if (!dashboardHeroPosters.length) {
            return;
        }
        if (dashboardHeroResizeTimer) {
            clearTimeout(dashboardHeroResizeTimer);
        }
        dashboardHeroResizeTimer = setTimeout(function() {
            renderDashboardHeroPosters(dashboardHeroPosters);
        }, 120);
    }

    function showNavigationLoading(titleText) {
        var overlay = document.getElementById('nav-loading-overlay');
        var titleEl = document.getElementById('nav-loading-title');
        var subtitleEl = document.getElementById('nav-loading-subtitle');
        if (!overlay || !titleEl || !subtitleEl) {
            return;
        }

        titleEl.textContent = 'Loading content details...';
        subtitleEl.textContent = titleText || 'Please wait';
        overlay.classList.add('is-open');
        overlay.setAttribute('aria-hidden', 'false');
    }

    function showAnalyticsRefreshLoading() {
        var overlay = document.getElementById('nav-loading-overlay');
        var titleEl = document.getElementById('nav-loading-title');
        var subtitleEl = document.getElementById('nav-loading-subtitle');
        if (!overlay || !titleEl || !subtitleEl) {
            return;
        }

        titleEl.textContent = 'Refreshing analytics...';
        subtitleEl.textContent = 'Processing data from your configured servers';
        overlay.classList.add('is-open');
        overlay.setAttribute('aria-hidden', 'false');
    }

    function bindAnalyticsRefreshForm() {
        var forms = document.querySelectorAll('form[action="{{ url_for("main.run_analytics") }}"]');
        forms.forEach(function(form) {
            form.addEventListener('submit', function(event) {
                if (analyticsRefreshInProgress) {
                    event.preventDefault();
                    return;
                }
                analyticsRefreshInProgress = true;
                var submitButton = form.querySelector('button[type="submit"], input[type="submit"]');
                if (submitButton) {
                    submitButton.disabled = true;
                }
                showAnalyticsRefreshLoading();
            });
        });
    }

    function ensureRefreshHelpTooltip() {
        if (refreshHelpTooltipEl) {
            return refreshHelpTooltipEl;
        }
        refreshHelpTooltipEl = document.createElement('div');
        refreshHelpTooltipEl.className = 'button-help-tooltip';
        refreshHelpTooltipEl.setAttribute('role', 'tooltip');
        document.body.appendChild(refreshHelpTooltipEl);
        return refreshHelpTooltipEl;
    }

    function placeRefreshHelpTooltip(target) {
        if (!target || !refreshHelpTooltipEl) {
            return;
        }
        var rect = target.getBoundingClientRect();
        var spacing = 10;
        var top = rect.bottom + spacing;
        var left = rect.left + (rect.width / 2);

        refreshHelpTooltipEl.style.left = '0px';
        refreshHelpTooltipEl.style.top = '0px';
        refreshHelpTooltipEl.style.maxWidth = '320px';

        var tooltipRect = refreshHelpTooltipEl.getBoundingClientRect();
        left = left - (tooltipRect.width / 2);

        var minLeft = 10;
        var maxLeft = window.innerWidth - tooltipRect.width - 10;
        if (left < minLeft) left = minLeft;
        if (left > maxLeft) left = maxLeft;

        if (top + tooltipRect.height > window.innerHeight - 10) {
            top = rect.top - tooltipRect.height - spacing;
        }

        refreshHelpTooltipEl.style.left = Math.round(left) + 'px';
        refreshHelpTooltipEl.style.top = Math.round(top) + 'px';
    }

    function showRefreshHelpTooltip(target) {
        var text = target && target.getAttribute('data-hover-help');
        if (!text) {
            return;
        }
        var tooltip = ensureRefreshHelpTooltip();
        tooltip.textContent = text;
        refreshHelpTargetEl = target;
        placeRefreshHelpTooltip(target);
        tooltip.classList.add('is-visible');
    }

    function hideRefreshHelpTooltip() {
        if (refreshHelpHoverTimer) {
            clearTimeout(refreshHelpHoverTimer);
            refreshHelpHoverTimer = null;
        }
        if (refreshHelpTooltipEl) {
            refreshHelpTooltipEl.classList.remove('is-visible');
        }
        refreshHelpTargetEl = null;
    }

    function bindRefreshHelpTooltip() {
        var buttons = document.querySelectorAll('.analytics-refresh-btn[data-hover-help]');
        buttons.forEach(function(button) {
            button.addEventListener('mouseenter', function() {
                hideRefreshHelpTooltip();
                refreshHelpHoverTimer = setTimeout(function() {
                    showRefreshHelpTooltip(button);
                }, 420);
            });
            button.addEventListener('mouseleave', hideRefreshHelpTooltip);
            button.addEventListener('blur', hideRefreshHelpTooltip);
            button.addEventListener('click', hideRefreshHelpTooltip);
            button.addEventListener('focus', function() {
                showRefreshHelpTooltip(button);
            });
        });

        window.addEventListener('scroll', function() {
            if (refreshHelpTargetEl) {
                placeRefreshHelpTooltip(refreshHelpTargetEl);
            }
        }, true);
        window.addEventListener('resize', function() {
            if (refreshHelpTargetEl) {
                placeRefreshHelpTooltip(refreshHelpTargetEl);
            }
        });
    }

    function preloadPosterPreviews(scope) {
        var $scope = scope ? $(scope) : $(document);
        $scope.find('.poster-preview').each(function() {
            var $preview = $(this);
            if ($preview.hasClass('loaded') || $preview.find('img').length) {
                return;
            }
            var url = $preview.data('poster-url');
            if (url) {
                var img = new Image();
                img.onload = function() {
                    $preview.append($('<img>').attr('src', url).attr('alt', 'Poster'));
                    $preview.addClass('loaded');
                };
                img.src = url;
            }
        });
    }

    function bindPosterPreviewHandlers() {
        if (posterPreviewBound) {
            return;
        }
        posterPreviewBound = true;

        $(document).on('mouseenter', '.title-with-preview', function() {
            var $preview = $(this).find('.poster-preview');
            if (!$preview.hasClass('loaded')) return;

            var rect = this.getBoundingClientRect();
            $preview.css({
                'left': rect.left + 'px',
                'top': (rect.bottom + 5) + 'px'
            });
            $preview.show();
        }).on('mouseleave', '.title-with-preview', function() {
            $(this).find('.poster-preview').hide();
        });
    }

    function formatElapsedTime(ms) {
        var seconds = Math.floor(ms / 1000);
        if (seconds < 60) {
            return 'Less than 1 minute ago';
        }

        var minutes = seconds / 60;
        if (minutes < 60) {
            var roundedMinutes = Math.round(minutes);
            return roundedMinutes === 1 ? '1 minute ago' : roundedMinutes + ' minutes ago';
        }

        var hours = minutes / 60;
        if (hours < 24) {
            var roundedHours = Math.round(hours * 2) / 2;
            var hoursLabel = (roundedHours % 1 === 0) ? roundedHours.toFixed(0) : roundedHours.toFixed(1);
            return roundedHours === 1 ? hoursLabel + ' hour ago' : hoursLabel + ' hours ago';
        }

        var days = Math.round(hours / 24);
        return days === 1 ? '1 day ago' : days + ' days ago';
    }

    function updateLastUpdatedLabel() {
        var label = document.getElementById('current-activity-last-updated');
        if (!label || !lastActivityUpdateAt) {
            return;
        }
        var elapsed = Date.now() - lastActivityUpdateAt;
        label.textContent = 'Last Updated: ' + formatElapsedTime(elapsed);
    }

    function refreshCurrentActivity() {
        var container = document.getElementById('current-activity-container');
        if (!container) {
            return;
        }

        fetch('{{ url_for("main.api_current_activity") }}', { cache: 'no-store' })
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('Failed to refresh current activity');
                }
                return response.text();
            })
            .then(function(html) {
                container.innerHTML = html;
                preloadPosterPreviews(container);
                lastActivityUpdateAt = Date.now();
                updateLastUpdatedLabel();
            })
            .catch(function(error) {
                console.error(error);
            });
    }

    function setRefreshInterval(minutes) {
        if (refreshTimer) {
            clearInterval(refreshTimer);
        }

        if (!minutes || minutes < 1) {
            return;
        }

        refreshTimer = setInterval(refreshCurrentActivity, minutes * 60 * 1000);
    }

    $(document).on('click', '#current-activity-container a.content-link', function(event) {
        var href = this.getAttribute('href');
        if (!href) {
            return;
        }

        if (
            event.metaKey ||
            event.ctrlKey ||
            event.shiftKey ||
            event.altKey ||
            (typeof event.button === 'number' && event.button !== 0)
        ) {
            return;
        }

        event.preventDefault();
        if (navigationInProgress) {
            return;
        }

        navigationInProgress = true;
        var titleText = (this.textContent || '').trim();
        showNavigationLoading(titleText);

        window.setTimeout(function() {
            window.location.href = href;
        }, 35);
    });

    bindPosterPreviewHandlers();
    bindAnalyticsRefreshForm();
    bindRefreshHelpTooltip();
    preloadPosterPreviews(document);
    loadDashboardHeroPosters();
    updateLastUpdatedLabel();
    window.addEventListener('resize', scheduleDashboardHeroRerender);

    lastUpdatedTimer = setInterval(updateLastUpdatedLabel, 30000);

    var refreshInput = document.getElementById('current-activity-refresh-minutes');
    if (refreshInput) {
        var initialMinutes = parseInt(refreshInput.value, 10);
        setRefreshInterval(initialMinutes);

        refreshInput.addEventListener('change', function() {
            var minutes = parseInt(refreshInput.value, 10);
            setRefreshInterval(minutes);
        });
    }

    // Initial chart data from server (rendered on page load)
    var chartsJson = {{ charts_json | tojson | safe }};

    // Render initial charts from cached data
    if (chartsJson.daily) {
        renderStackedBarChart('daily-chart-container', chartsJson.daily);
    }
    if (chartsJson.monthly) {
        renderStackedBarChart('monthly-chart-container', chartsJson.monthly);
    }
    if (chartsJson.category) {
        renderPieChart('distribution-category-container', chartsJson.category);
    }
    if (chartsJson.server) {
        renderPieChart('distribution-server-container', chartsJson.server);
    }
    if (chartsJson.platform) {
        renderPieChart('distribution-platform-container', chartsJson.platform);
    }
    if (chartsJson.users) {
        renderUserStackedBarChart('user-chart-container', chartsJson.users);
    }
    if (chartsJson.movies) {
        renderGradientBarChart('movie-chart-container', chartsJson.movies);
    }
    if (chartsJson.tv) {
        renderGradientBarChart('tv-chart-container', chartsJson.tv);
    }

    // Load users for filter dropdown
    function loadUserFilter() {
        var select = document.getElementById('activity-user-filter');
        if (!select) return;

        fetch('{{ url_for("main.api_users_list") }}')
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('Failed to load users');
                }
                return response.json();
            })
            .then(function(data) {
                // Keep the "All Users" option
                select.innerHTML = '<option value="">All Users</option>';
                data.users.forEach(function(user) {
                    var option = document.createElement('option');
                    option.value = user.user_id;
                    option.textContent = user.friendly_name;
                    select.appendChild(option);
                });
            })
            .catch(function(error) {
                console.error('Error loading users:', error);
            });
    }

    // Load user filter on page load
    loadUserFilter();

    // Get selected user ID from filter
    function getSelectedUserId() {
        var select = document.getElementById('activity-user-filter');
        return select && select.value ? parseInt(select.value, 10) : null;
    }

    // Daily chart range controls
    function fetchDailyChart(days) {
        var container = document.getElementById('daily-chart-container');
        if (!container || !days) {
            return;
        }

        container.classList.add('is-loading');

        var url = '{{ url_for("main.api_daily_chart") }}?days=' + encodeURIComponent(days);
        var userId = getSelectedUserId();
        if (userId) {
            url += '&user_id=' + encodeURIComponent(userId);
        }

        fetch(url)
            .then(function(response) {
                if (!response.ok) {
                    return response.json().then(function(payload) {
                        throw new Error(payload.error || 'Failed to load chart.');
                    });
                }
                return response.json();
            })
            .then(function(payload) {
                renderStackedBarChart('daily-chart-container', payload.chart_data);
                setActiveRange('daily-range-form', 'daily_trend_days_custom', payload.daily_trend_days, [7, 30, 60, 90]);
            })
            .catch(function(error) {
                alert(error.message || 'Unable to update the daily chart.');
            })
            .finally(function() {
                container.classList.remove('is-loading');
            });
    }

    document.querySelectorAll('#daily-range-form .range-pill[data-days]').forEach(function(button) {
        button.addEventListener('click', function() {
            var value = parseInt(button.getAttribute('data-days'), 10);
            if (value) {
                fetchDailyChart(value);
            }
        });
    });

    var applyButton = document.querySelector('#daily-range-form .range-custom .range-apply');
    if (applyButton) {
        applyButton.addEventListener('click', function() {
            var customInput = document.querySelector('#daily-range-form input[name="daily_trend_days_custom"]');
            var value = customInput ? parseInt(customInput.value, 10) : null;
            if (!value || value < 1 || value > 3650) {
                alert('Please enter a valid number of days (1-3650).');
                return;
            }
            fetchDailyChart(value);
        });
    }

    // Monthly chart range controls
    function fetchMonthlyChart(months) {
        var container = document.getElementById('monthly-chart-container');
        if (!container || !months) {
            return;
        }

        container.classList.add('is-loading');

        var url = '{{ url_for("main.api_monthly_chart") }}?months=' + encodeURIComponent(months);
        var userId = getSelectedUserId();
        if (userId) {
            url += '&user_id=' + encodeURIComponent(userId);
        }

        fetch(url)
            .then(function(response) {
                if (!response.ok) {
                    return response.json().then(function(payload) {
                        throw new Error(payload.error || 'Failed to load chart.');
                    });
                }
                return response.json();
            })
            .then(function(payload) {
                renderStackedBarChart('monthly-chart-container', payload.chart_data);
                setActiveRange('monthly-range-form', 'monthly_trend_months_custom', payload.monthly_trend_months, [12, 24, 60, 120]);
            })
            .catch(function(error) {
                alert(error.message || 'Unable to update the monthly chart.');
            })
            .finally(function() {
                container.classList.remove('is-loading');
            });
    }

    document.querySelectorAll('.range-pill[data-months]').forEach(function(button) {
        button.addEventListener('click', function() {
            var value = parseInt(button.getAttribute('data-months'), 10);
            if (value) {
                fetchMonthlyChart(value);
            }
        });
    });

    var monthlyApplyButton = document.querySelector('#monthly-range-form .range-custom .range-apply-monthly');
    if (monthlyApplyButton) {
        monthlyApplyButton.addEventListener('click', function() {
            var customInput = document.querySelector('#monthly-range-form input[name="monthly_trend_months_custom"]');
            var value = customInput ? parseInt(customInput.value, 10) : null;
            if (!value || value < 1 || value > 120) {
                alert('Please enter a valid number of months (1-120).');
                return;
            }
            fetchMonthlyChart(value);
        });
    }

    // User filter change handler - refreshes both daily and monthly charts
    var userFilterSelect = document.getElementById('activity-user-filter');
    if (userFilterSelect) {
        userFilterSelect.addEventListener('change', function() {
            // Get current daily range
            var dailyActiveBtn = document.querySelector('#daily-range-form .range-pill.active[data-days]');
            var dailyCustomInput = document.querySelector('#daily-range-form input[name="daily_trend_days_custom"]');
            var dailyDays = dailyActiveBtn ? parseInt(dailyActiveBtn.getAttribute('data-days'), 10) : (dailyCustomInput && dailyCustomInput.value ? parseInt(dailyCustomInput.value, 10) : {{ summary.daily_trend_days }});

            // Get current monthly range
            var monthlyActiveBtn = document.querySelector('#monthly-range-form .range-pill.active[data-months]');
            var monthlyCustomInput = document.querySelector('#monthly-range-form input[name="monthly_trend_months_custom"]');
            var monthlyMonths = monthlyActiveBtn ? parseInt(monthlyActiveBtn.getAttribute('data-months'), 10) : (monthlyCustomInput && monthlyCustomInput.value ? parseInt(monthlyCustomInput.value, 10) : {{ summary.monthly_trend_months }});

            // Refresh both charts with the selected user
            if (dailyDays) {
                fetchDailyChart(dailyDays);
            }
            if (monthlyMonths) {
                fetchMonthlyChart(monthlyMonths);
            }
        });
    }

    // Concurrent streams chart range controls
    function fetchConcurrentStreams(days) {
        var container = document.getElementById('concurrent-chart-container');
        if (!container || !days) {
            return;
        }

        container.classList.add('is-loading');

        fetch('{{ url_for("main.api_concurrent_streams") }}?days=' + encodeURIComponent(days))
            .then(function(response) {
                if (!response.ok) {
                    return response.json().then(function(payload) {
                        throw new Error(payload.error || 'Failed to load chart.');
                    });
                }
                return response.json();
            })
            .then(function(payload) {
                renderAreaChart('concurrent-chart-container', payload.chart_data);
                setActiveRange('concurrent-range-form', 'concurrent_days_custom', payload.concurrent_streams_days, [7, 30, 60, 90]);
            })
            .catch(function(error) {
                alert(error.message || 'Unable to update the concurrent streams chart.');
            })
            .finally(function() {
                container.classList.remove('is-loading');
            });
    }

    // Load initial concurrent streams chart (default 60 days)
    fetchConcurrentStreams(60);

    document.querySelectorAll('#concurrent-range-form .range-pill[data-days]').forEach(function(button) {
        button.addEventListener('click', function() {
            var value = parseInt(button.getAttribute('data-days'), 10);
            if (value) {
                fetchConcurrentStreams(value);
            }
        });
    });

    var concurrentApplyButton = document.querySelector('#concurrent-range-form .range-custom .range-apply-concurrent');
    if (concurrentApplyButton) {
        concurrentApplyButton.addEventListener('click', function() {
            var customInput = document.querySelector('#concurrent-range-form input[name="concurrent_days_custom"]');
            var value = customInput ? parseInt(customInput.value, 10) : null;
            if (!value || value < 1 || value > 3650) {
                alert('Please enter a valid number of days (1-3650).');
                return;
            }
            fetchConcurrentStreams(value);
        });
    }

    // Distribution charts range controls
    function fetchDistributionCharts(days) {
        var categoryContainer = document.getElementById('distribution-category-container');
        var serverContainer = document.getElementById('distribution-server-container');
        var platformContainer = document.getElementById('distribution-platform-container');

        if (!categoryContainer || !serverContainer || !platformContainer || !days) {
            return;
        }

        categoryContainer.classList.add('is-loading');
        serverContainer.classList.add('is-loading');
        platformContainer.classList.add('is-loading');

        fetch('{{ url_for("main.api_distribution_charts") }}?days=' + encodeURIComponent(days))
            .then(function(response) {
                if (!response.ok) {
                    return response.json().then(function(payload) {
                        throw new Error(payload.error || 'Failed to load charts.');
                    });
                }
                return response.json();
            })
            .then(function(payload) {
                renderPieChart('distribution-category-container', payload.category);
                renderPieChart('distribution-server-container', payload.server);
                renderPieChart('distribution-platform-container', payload.platform);
                setActiveRange('distribution-range-form', 'distribution_days_custom', payload.distribution_days, [7, 30, 60, 90]);
            })
            .catch(function(error) {
                alert(error.message || 'Unable to update the distribution charts.');
            })
            .finally(function() {
                categoryContainer.classList.remove('is-loading');
                serverContainer.classList.remove('is-loading');
                platformContainer.classList.remove('is-loading');
            });
    }

    document.querySelectorAll('#distribution-range-form .range-pill[data-days]').forEach(function(button) {
        button.addEventListener('click', function() {
            var value = parseInt(button.getAttribute('data-days'), 10);
            if (value) {
                fetchDistributionCharts(value);
            }
        });
    });

    var distributionApplyButton = document.querySelector('#distribution-range-form .range-custom .range-apply-distribution');
    if (distributionApplyButton) {
        distributionApplyButton.addEventListener('click', function() {
            var customInput = document.querySelector('#distribution-range-form input[name="distribution_days_custom"]');
            var value = customInput ? parseInt(customInput.value, 10) : null;
            if (!value || value < 1 || value > 3650) {
                alert('Please enter a valid number of days (1-3650).');
                return;
            }
            fetchDistributionCharts(value);
        });
    }

    // User chart range controls
    function fetchUserChart(days, topN) {
        var container = document.getElementById('user-chart-container');
        if (!container || !days) {
            return;
        }

        var topNInput = document.getElementById('user-top-n');
        var topNValue = topN || (topNInput ? parseInt(topNInput.value, 10) : null);

        container.classList.add('is-loading');

        var url = '{{ url_for("main.api_user_chart") }}?days=' + encodeURIComponent(days);
        if (topNValue) {
            url += '&top_n=' + encodeURIComponent(topNValue);
        }

        fetch(url)
            .then(function(response) {
                if (!response.ok) {
                    return response.json().then(function(payload) {
                        throw new Error(payload.error || 'Failed to load chart.');
                    });
                }
                return response.json();
            })
            .then(function(payload) {
                renderUserStackedBarChart('user-chart-container', payload.chart_data);
                setActiveRange('user-range-form', 'user_days_custom', payload.user_chart_days, [7, 30, 60, 90]);
                if (topNInput && payload.top_users) {
                    topNInput.value = payload.top_users;
                }
            })
            .catch(function(error) {
                alert(error.message || 'Unable to update the user chart.');
            })
            .finally(function() {
                container.classList.remove('is-loading');
            });
    }

    document.querySelectorAll('#user-range-form .range-pill[data-days]').forEach(function(button) {
        button.addEventListener('click', function() {
            var value = parseInt(button.getAttribute('data-days'), 10);
            if (value) {
                fetchUserChart(value);
            }
        });
    });

    var userApplyButton = document.querySelector('#user-range-form .range-custom .range-apply-user');
    if (userApplyButton) {
        userApplyButton.addEventListener('click', function() {
            var customInput = document.querySelector('#user-range-form input[name="user_days_custom"]');
            var value = customInput ? parseInt(customInput.value, 10) : null;
            if (!value || value < 1 || value > 3650) {
                alert('Please enter a valid number of days (1-3650).');
                return;
            }
            fetchUserChart(value);
        });
    }

    // User top-n change handler
    var userTopNInput = document.getElementById('user-top-n');
    if (userTopNInput) {
        userTopNInput.addEventListener('change', function() {
            var activeBtn = document.querySelector('#user-range-form .range-pill.active[data-days]');
            var customInput = document.querySelector('#user-range-form input[name="user_days_custom"]');
            var days = activeBtn ? parseInt(activeBtn.getAttribute('data-days'), 10) : (customInput ? parseInt(customInput.value, 10) : null);
            if (days) {
                fetchUserChart(days);
            }
        });
    }

    // Movie chart range controls
    function fetchMovieChart(days, topN) {
        var container = document.getElementById('movie-chart-container');
        if (!container || !days) {
            return;
        }

        var topNInput = document.getElementById('movie-top-n');
        var topNValue = topN || (topNInput ? parseInt(topNInput.value, 10) : null);

        container.classList.add('is-loading');

        var url = '{{ url_for("main.api_movie_chart") }}?days=' + encodeURIComponent(days);
        if (topNValue) {
            url += '&top_n=' + encodeURIComponent(topNValue);
        }

        fetch(url)
            .then(function(response) {
                if (!response.ok) {
                    return response.json().then(function(payload) {
                        throw new Error(payload.error || 'Failed to load chart.');
                    });
                }
                return response.json();
            })
            .then(function(payload) {
                renderGradientBarChart('movie-chart-container', payload.chart_data);
                setActiveRange('movie-range-form', 'movie_days_custom', payload.movie_chart_days, [7, 30, 60, 90]);
                if (topNInput && payload.top_movies) {
                    topNInput.value = payload.top_movies;
                }
            })
            .catch(function(error) {
                alert(error.message || 'Unable to update the movie chart.');
            })
            .finally(function() {
                container.classList.remove('is-loading');
            });
    }

    document.querySelectorAll('#movie-range-form .range-pill[data-days]').forEach(function(button) {
        button.addEventListener('click', function() {
            var value = parseInt(button.getAttribute('data-days'), 10);
            if (value) {
                fetchMovieChart(value);
            }
        });
    });

    var movieApplyButton = document.querySelector('#movie-range-form .range-custom .range-apply-movie');
    if (movieApplyButton) {
        movieApplyButton.addEventListener('click', function() {
            var customInput = document.querySelector('#movie-range-form input[name="movie_days_custom"]');
            var value = customInput ? parseInt(customInput.value, 10) : null;
            if (!value || value < 1 || value > 3650) {
                alert('Please enter a valid number of days (1-3650).');
                return;
            }
            fetchMovieChart(value);
        });
    }

    // Movie top-n change handler
    var movieTopNInput = document.getElementById('movie-top-n');
    if (movieTopNInput) {
        movieTopNInput.addEventListener('change', function() {
            var activeBtn = document.querySelector('#movie-range-form .range-pill.active[data-days]');
            var customInput = document.querySelector('#movie-range-form input[name="movie_days_custom"]');
            var days = activeBtn ? parseInt(activeBtn.getAttribute('data-days'), 10) : (customInput ? parseInt(customInput.value, 10) : null);
            if (days) {
                fetchMovieChart(days);
            }
        });
    }

    // TV chart range controls
    function fetchTvChart(days, topN) {
        var container = document.getElementById('tv-chart-container');
        if (!container || !days) {
            return;
        }

        var topNInput = document.getElementById('tv-top-n');
        var topNValue = topN || (topNInput ? parseInt(topNInput.value, 10) : null);

        container.classList.add('is-loading');

        var url = '{{ url_for("main.api_tv_chart") }}?days=' + encodeURIComponent(days);
        if (topNValue) {
            url += '&top_n=' + encodeURIComponent(topNValue);
        }

        fetch(url)
            .then(function(response) {
                if (!response.ok) {
                    return response.json().then(function(payload) {
                        throw new Error(payload.error || 'Failed to load chart.');
                    });
                }
                return response.json();
            })
            .then(function(payload) {
                renderGradientBarChart('tv-chart-container', payload.chart_data);
                setActiveRange('tv-range-form', 'tv_days_custom', payload.tv_chart_days, [7, 30, 60, 90]);
                if (topNInput && payload.top_tv_shows) {
                    topNInput.value = payload.top_tv_shows;
                }
            })
            .catch(function(error) {
                alert(error.message || 'Unable to update the TV chart.');
            })
            .finally(function() {
                container.classList.remove('is-loading');
            });
    }

    document.querySelectorAll('#tv-range-form .range-pill[data-days]').forEach(function(button) {
        button.addEventListener('click', function() {
            var value = parseInt(button.getAttribute('data-days'), 10);
            if (value) {
                fetchTvChart(value);
            }
        });
    });

    var tvApplyButton = document.querySelector('#tv-range-form .range-custom .range-apply-tv');
    if (tvApplyButton) {
        tvApplyButton.addEventListener('click', function() {
            var customInput = document.querySelector('#tv-range-form input[name="tv_days_custom"]');
            var value = customInput ? parseInt(customInput.value, 10) : null;
            if (!value || value < 1 || value > 3650) {
                alert('Please enter a valid number of days (1-3650).');
                return;
            }
            fetchTvChart(value);
        });
    }

    // TV top-n change handler
    var tvTopNInput = document.getElementById('tv-top-n');
    if (tvTopNInput) {
        tvTopNInput.addEventListener('change', function() {
            var activeBtn = document.querySelector('#tv-range-form .range-pill.active[data-days]');
            var customInput = document.querySelector('#tv-range-form input[name="tv_days_custom"]');
            var days = activeBtn ? parseInt(activeBtn.getAttribute('data-days'), 10) : (customInput ? parseInt(customInput.value, 10) : null);
            if (days) {
                fetchTvChart(days);
            }
        });
    }
});
</script>
{% endif %}
{% endblock %}
