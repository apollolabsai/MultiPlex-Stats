{% extends "base.html" %}

{% block title %}{{ content_title }} - MultiPlex Stats{% endblock %}

{% macro rating_icon(image) -%}
    {% if image and image.startswith('imdb://') -%}
        <img src="{{ url_for('static', filename='img/imdb.svg') }}" class="hero-rating-icon" alt="IMDb">
    {%- elif image and image.startswith('rottentomatoes://') -%}
        <img src="{{ url_for('static', filename='img/rottentomatoes.svg') }}" class="hero-rating-icon" alt="Rotten Tomatoes">
    {%- elif image and image.startswith('themoviedb://') -%}
        <img src="{{ url_for('static', filename='img/themoviedb.svg') }}" class="hero-rating-icon" alt="TMDb">
    {%- endif %}
{%- endmacro %}

{% block content %}
<section class="content-hero{% if metadata.banner_url %} has-banner{% endif %}"{% if metadata.banner_url %} style="background-image: url('{{ metadata.banner_url }}');"{% endif %}>
    <div class="content-hero-overlay"></div>
    <div class="content-hero-inner">
        <div class="content-poster-wrap">
            {% if metadata.poster_url %}
            <img src="{{ metadata.poster_url }}" alt="{{ content_title }} poster" class="content-poster">
            {% else %}
            <div class="content-poster-placeholder">No Poster</div>
            {% endif %}
        </div>
        <div class="content-meta">
            <h2>{{ content_title }}</h2>
            <div class="hero-stats">
                <div class="hero-stat">
                    <span class="hero-stat-number">{{ "{:,}".format(total_plays) }}</span>
                    <span class="hero-stat-label">Total Plays</span>
                </div>
                <div class="hero-stat">
                    <span class="hero-stat-number">{{ "{:,}".format(unique_users) }}</span>
                    <span class="hero-stat-label">Unique Users</span>
                </div>
                <div class="hero-stat">
                    <span class="hero-stat-number">{{ metadata.date_added or "Unknown" }}</span>
                    <span class="hero-stat-label">Date Added</span>
                </div>
                {% if not is_movie %}
                <div class="hero-stat">
                    <span class="hero-stat-number">{{ metadata.year or "Unknown" }}</span>
                    <span class="hero-stat-label">Aired Year</span>
                </div>
                <div class="hero-stat">
                    <span class="hero-stat-number">{{ "{:,}".format(metadata.season_count) if metadata.season_count is not none and metadata.season_count != '' else "Unknown" }}</span>
                    <span class="hero-stat-label">Seasons</span>
                </div>
                <div class="hero-stat">
                    <span class="hero-stat-number">{{ "{:,}".format(metadata.episode_count) if metadata.episode_count is not none and metadata.episode_count != '' else "Unknown" }}</span>
                    <span class="hero-stat-label">Episodes</span>
                </div>
                {% endif %}
            </div>
            {% if metadata.critic_rating_display or metadata.audience_rating_display %}
            <div class="hero-ratings">
                {% if metadata.critic_rating_display %}
                <div class="hero-rating-pill">
                    {{ rating_icon(metadata.critic_rating_image) }}
                    <span class="hero-rating-value">{{ metadata.critic_rating_display }}</span>
                    <span class="hero-rating-type">Critic</span>
                </div>
                {% endif %}
                {% if metadata.audience_rating_display %}
                <div class="hero-rating-pill">
                    {{ rating_icon(metadata.audience_rating_image) }}
                    <span class="hero-rating-value">{{ metadata.audience_rating_display }}</span>
                    <span class="hero-rating-type">Audience</span>
                </div>
                {% endif %}
            </div>
            {% endif %}
            <p class="summary">{{ metadata.summary }}</p>

            {% if is_movie %}
            <div class="meta-grid">
                <div class="meta-item"><span class="meta-label">Directed by</span><span class="meta-value">{{ metadata.director or "Unknown" }}</span></div>
                <div class="meta-item"><span class="meta-label">Studio</span><span class="meta-value">{{ metadata.studio or "Unknown" }}</span></div>
                <div class="meta-item"><span class="meta-label">Year</span><span class="meta-value">{{ metadata.year or "Unknown" }}</span></div>
                <div class="meta-item"><span class="meta-label">Runtime</span><span class="meta-value">{{ metadata.runtime or "Unknown" }}</span></div>
                <div class="meta-item"><span class="meta-label">Rated</span><span class="meta-value">{{ metadata.rated or "Unknown" }}</span></div>
                <div class="meta-item"><span class="meta-label">Video Codec</span><span class="meta-value">{{ metadata.video_codec or "Unknown" }}</span></div>
                <div class="meta-item"><span class="meta-label">Resolution</span><span class="meta-value">{{ metadata.resolution or "Unknown" }}</span></div>
                <div class="meta-item"><span class="meta-label">Audio</span><span class="meta-value">{{ metadata.audio or "Unknown" }}</span></div>
            </div>
            {% endif %}
        </div>
    </div>
</section>

<div class="section">
    <h2 class="section-title">Plays by Year (All Servers)</h2>
    <div class="chart-total-label" id="plays-chart-total"></div>
    <div class="chart-container" id="plays-by-year-chart"></div>
</div>

{% if not is_movie %}
<div class="section">
    <h2 class="section-title">Plays by User (All Servers)</h2>
    <div class="chart-container" id="plays-by-user-chart"></div>
</div>
{% endif %}

<div class="section">
    <h2 class="section-title">Detailed Watch History</h2>
    <div class="table-container">
        <table id="detailHistoryTable" class="display detail-history-table" style="width:100%">
            <thead>
                <tr>
                    <th style="width: 120px;">Date</th>
                    <th style="display:none;">Sortable DateTime</th>
                    <th style="width: 80px;">Server</th>
                    <th style="width: 100px;">User</th>
                    <th style="width: 300px;">Content</th>
                    <th style="width: 100px;">IP Address</th>
                    <th style="width: 100px;">Platform</th>
                    <th style="width: 80px;">Quality</th>
                    <th style="width: 120px;">Progress</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<style>
.back-btn {
    margin-top: 12px;
}

.content-hero {
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 24px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    background: linear-gradient(135deg, #141414 0%, #222 100%);
    background-size: cover;
    background-position: center;
}

.content-hero-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
}

.content-hero.has-banner .content-hero-overlay {
    background: rgba(0, 0, 0, 0.5);
}

.content-hero-inner {
    position: relative;
    z-index: 1;
    display: grid;
    grid-template-columns: 240px 1fr;
    gap: 24px;
    padding: 22px;
}

.content-poster-wrap {
    width: 240px;
}

.content-poster {
    width: 100%;
    border-radius: 10px;
    border: 2px solid rgba(255, 255, 255, 0.15);
}

.content-poster-placeholder {
    width: 100%;
    height: 360px;
    border-radius: 10px;
    border: 2px dashed rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #aaa;
    background: rgba(0, 0, 0, 0.3);
}

.content-meta h2 {
    margin: 0 0 12px 0;
    color: #fff;
}

.summary {
    color: #ddd;
    line-height: 1.5;
    margin-bottom: 16px;
}

.hero-ratings {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin: 8px 0 14px;
}

.hero-rating-pill {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 7px 11px;
    border-radius: 999px;
    background: rgba(0, 0, 0, 0.35);
    border: 1px solid rgba(255, 255, 255, 0.12);
}

.hero-rating-icon {
    width: 18px;
    height: 18px;
}

.hero-rating-value {
    color: #fff;
    font-weight: 700;
}

.hero-rating-type {
    color: #f18a3d;
    font-size: 0.78em;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.hero-stats {
    display: flex;
    gap: 16px;
    margin: 8px 0 14px 0;
}

.hero-stat {
    display: flex;
    flex-direction: column;
    gap: 2px;
    padding: 8px 12px;
    border-radius: 8px;
    background: rgba(0, 0, 0, 0.35);
    border: 1px solid rgba(255, 255, 255, 0.12);
}

.hero-stat-number {
    color: #fff;
    font-size: 1.1em;
    font-weight: 700;
}

.hero-stat-label {
    color: #f18a3d;
    font-size: 0.78em;
    text-transform: uppercase;
    letter-spacing: 0.06em;
}

.chart-total-label {
    margin-bottom: 10px;
    color: #f18a3d;
    font-weight: 600;
    letter-spacing: 0.03em;
}

.meta-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 10px 16px;
}

.meta-item {
    display: flex;
    flex-direction: column;
    gap: 3px;
}

.meta-label {
    color: #f18a3d;
    font-size: 0.82em;
    text-transform: uppercase;
    letter-spacing: 0.06em;
}

.meta-value {
    color: #fff;
}

.detail-history-table td,
.detail-history-table th {
    vertical-align: middle;
}

@media (max-width: 900px) {
    .content-hero-inner {
        grid-template-columns: 1fr;
    }
    .content-poster-wrap {
        width: 200px;
    }
    .hero-stats {
        flex-direction: column;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var movieIcon = '<svg class="media-icon" fill="#ed542c" viewBox="0 0 24 24"><path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"/></svg>';
    var tvIcon = '<svg class="media-icon" fill="#ed542c" viewBox="0 0 24 24"><path d="M21 3H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h5v2h8v-2h5c1.1 0 1.99-.9 1.99-2L23 5c0-1.1-.9-2-2-2zm0 14H3V5h18v12z"/></svg>';
    var watchHistoryRows = {{ watch_history | tojson }};

    var chartPayload = {{ plays_chart | tojson }};
    var playsByUserPayload = {{ plays_by_user_chart | tojson }};
    var endpointTotalPlays = {{ total_plays | tojson }};
    var overallTotal = chartPayload.overall_total || 0;
    var totalLabel = document.getElementById('plays-chart-total');
    if (totalLabel) {
        totalLabel.textContent = 'Total Plays (All-Time, All Servers): ' + endpointTotalPlays.toLocaleString();
    }

    Highcharts.chart('plays-by-year-chart', {
        chart: {
            type: 'column',
            height: 420
        },
        title: {
            text: chartPayload.title
        },
        xAxis: {
            categories: chartPayload.categories,
            title: { text: 'Year' }
        },
        yAxis: {
            min: 0,
            allowDecimals: false,
            title: { text: 'Play Count' },
            stackLabels: {
                enabled: true,
                style: {
                    color: '#fff',
                    fontSize: '11px',
                    fontWeight: 'bold',
                    textOutline: 'none'
                },
                formatter: function() {
                    return Highcharts.numberFormat(this.total, 0, '', ',');
                }
            }
        },
        legend: {
            enabled: true,
            align: 'center',
            verticalAlign: 'bottom',
            layout: 'horizontal'
        },
        tooltip: {
            headerFormat: '<b>{point.category}</b><br/>',
            pointFormat: '{series.name}: {point.y:,.0f}<br/>Total: {point.stackTotal:,.0f}'
        },
        plotOptions: {
            column: {
                stacking: 'normal',
                borderWidth: 0
            }
        },
        series: chartPayload.series || []
    });

    if (playsByUserPayload && document.getElementById('plays-by-user-chart')) {
        renderGradientBarChart('plays-by-user-chart', playsByUserPayload, {
            minHeight: 300
        });
    }

    $('#detailHistoryTable').DataTable({
        data: watchHistoryRows,
        pageLength: 50,
        order: [[1, 'desc']],
        lengthMenu: [[25, 50, 100, 200], [25, 50, 100, 200]],
        columns: [
            {
                data: null,
                render: function(data, type, row) {
                    return '<div class="datetime-cell">' +
                           '<span class="date-text">' + (row.date_pt || '') + '</span>' +
                           '<span class="time-text">' + (row.time_pt || '') + '</span>' +
                           '</div>';
                }
            },
            { data: 'sortable_datetime', visible: false },
            {
                data: null,
                render: function(data, type, row) {
                    return '<span class="server-badge ' + (row.server_order || '') + '">' +
                           (row.Server || '') + '</span>';
                }
            },
            { data: 'user' },
            {
                data: null,
                render: function(data, type, row) {
                    var icon = (row.media_type || '').toLowerCase() === 'movie' ? movieIcon : tvIcon;
                    var html = '<div class="content-cell"><div>' + icon +
                               '<span class="content-title">' + (row.title || '') + '</span></div>';
                    if (row.subtitle) {
                        html += '<div class="content-subtitle">' + row.subtitle + '</div>';
                    }
                    html += '</div>';
                    return html;
                }
            },
            { data: 'ip_address' },
            {
                data: null,
                render: function(data, type, row) {
                    var html = '<div class="content-cell">' +
                               '<div class="platform-name">' + (row.platform || '') + '</div>';
                    if (row.product) {
                        html += '<div class="platform-product">' + row.product + '</div>';
                    }
                    html += '</div>';
                    return html;
                }
            },
            {
                data: null,
                render: function(data, type, row) {
                    if (!row.quality) {
                        return '<span style="color: #888;">N/A</span>';
                    }
                    var badgeClass = 'quality-badge';
                    if (row.quality === 'Direct Play') badgeClass += ' direct-play';
                    else if (row.quality === 'Transcode') badgeClass += ' transcode';
                    else if (row.quality === 'Direct Stream') badgeClass += ' direct-stream';
                    return '<span class="' + badgeClass + '">' + row.quality + '</span>';
                }
            },
            {
                data: null,
                render: function(data, type, row) {
                    var percent = row.percent_complete || 0;
                    return '<div class="progress-bar-container">' +
                           '<div class="progress-bar-fill orange" style="width: ' + percent + '%;"></div>' +
                           '</div>' +
                           '<div class="progress-text">' + percent + '%</div>';
                }
            }
        ],
        columnDefs: [
            { targets: 1, visible: false }
        ],
        language: {
            search: "Filter records:",
            lengthMenu: "Show _MENU_ entries",
            info: "Showing _START_ to _END_ of _TOTAL_ viewing records",
            infoEmpty: "No viewing history for this title.",
            emptyTable: "No viewing history for this title."
        }
    });
});
</script>
{% endblock %}
