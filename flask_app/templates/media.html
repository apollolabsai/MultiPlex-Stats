{% extends "base.html" %}

{% block title %}Media Library - MultiPlex Stats{% endblock %}

{% block content %}
<header class="media-hero" id="media-hero">
    <div class="media-hero-backdrop" id="media-hero-backdrop" aria-hidden="true"></div>
    <div class="media-hero-overlay" aria-hidden="true"></div>
    <h1 class="settings-title">Media Library</h1>
    <div class="subtitle">Movies and TV Shows from all servers</div>
</header>

{% set initial_load_complete = sync_status.has_data and lifetime_sync_status.has_data and sync_status.status != 'running' and lifetime_sync_status.status != 'running' %}

<!-- Load/Refresh Section -->
<div class="media-load-section" id="media-load-section" {% if initial_load_complete %}style="display: none;"{% endif %}>
    <div class="form-card load-card">
        <div class="load-header">
            <svg class="load-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
            </svg>
            <div class="load-text">
                <h3>Load and Refresh Media Data</h3>
                <p>One action runs media import first, then builds the lifetime play count cache.</p>
            </div>
        </div>

        <div class="load-process-copy">
            <p><strong>Step 1:</strong> Import movies and TV shows from each configured server.</p>
            <p><strong>Step 2:</strong> Build lifetime play counts from full history so titles with multiple keys are merged correctly. Some Tautulli servers assign multiple keys to the same title over time. We build a full-history cache so media page play counts are merged across those keys without slowing page load.</p>
            <p>Both steps include per-server progress polling.</p>
        </div>

        <!-- Step 1 Progress -->
        <div class="sync-progress" id="sync-progress" {% if sync_status.status != 'running' %}style="display: none;"{% endif %}>
            <div class="progress-phase-title">Step 1 of 2: Media Library Sync</div>
            <div id="server-progress-container">
                <!-- Server progress bars will be dynamically inserted here -->
            </div>
            <div class="progress-stats">
                <span id="progress-fetched">{{ sync_status.records_fetched or 0 }}</span> total records fetched
            </div>
        </div>

        <!-- Step 2 Progress -->
        <div class="sync-progress" id="lifetime-sync-progress" {% if lifetime_sync_status.status != 'running' %}style="display: none;"{% endif %}>
            <div class="progress-phase-title">Step 2 of 2: Lifetime Play Count Cache</div>
            <div id="lifetime-server-progress-container"></div>
            <div class="progress-stats">
                <span id="lifetime-progress-fetched">{{ lifetime_sync_status.records_fetched or 0 }}</span> history rows processed
            </div>
        </div>

        <button type="button" class="btn btn-primary btn-large" id="run-full-refresh-btn" {% if sync_status.status == 'running' or lifetime_sync_status.status == 'running' %}disabled{% endif %}>
            {% if sync_status.status == 'running' %}
            Loading Media Library...
            {% elif lifetime_sync_status.status == 'running' %}
            Building Lifetime Play Counts...
            {% elif sync_status.has_data %}
            Refresh Media Data
            {% else %}
            Load Media Data
            {% endif %}
        </button>
        <div class="last-sync-info">This can take over 5 minutes depending on library size.</div>
        <div class="last-sync-info" id="media-last-sync-label">
            {% if sync_status.last_sync_date %}
            Last media load: {{ sync_status.last_sync_date }}
            {% else %}
            Last media load: Never
            {% endif %}
        </div>
        <div class="last-sync-info" id="lifetime-last-sync-label">
            {% if lifetime_sync_status.last_sync_date %}
            Last lifetime cache refresh: {{ lifetime_sync_status.last_sync_date }}
            {% else %}
            Last lifetime cache refresh: Never
            {% endif %}
        </div>
    </div>
</div>

<!-- Stats Grid -->
<div class="stats-grid" id="stats-grid" {% if not sync_status.has_data %}style="display: none;"{% endif %}>
    <div class="stat-card">
        <div class="stat-number" id="stat-movies-count">{{ "{:,}".format(movies|length) }}</div>
        <div class="stat-label">Movies</div>
    </div>
    <div class="stat-card">
        <div class="stat-number" id="stat-tv-count">{{ "{:,}".format(tv_shows|length) }}</div>
        <div class="stat-label">TV Shows</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ "{:,}".format(total_movie_plays) }}</div>
        <div class="stat-label">Movie Plays</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ "{:,}".format(total_tv_plays) }}</div>
        <div class="stat-label">TV Plays</div>
    </div>
</div>

<div class="media-controls-row" id="media-controls-row" {% if not sync_status.has_data %}style="display: none;"{% endif %}>
    <div class="media-table-toggle" id="media-table-toggle">
        <button type="button" class="btn btn-secondary media-toggle-btn active" id="media-tab-movies">Movies</button>
        <button type="button" class="btn btn-secondary media-toggle-btn" id="media-tab-tv">TV Shows</button>
    </div>
    <div class="media-actions" id="media-actions">
        <button type="button" class="btn btn-secondary" id="export-section-btn">Export Movies CSV</button>
        <button type="button" class="btn btn-primary" id="refresh-media-inline-btn">Refresh Media Data</button>
    </div>
</div>

<!-- Movies Section -->
<div class="section" id="movies-section" {% if not sync_status.has_data %}style="display: none;"{% endif %}>
    <h2 class="section-header">
        <svg class="section-icon" width="24" height="24" viewBox="0 0 24 24" fill="#ed542c">
            <path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"/>
        </svg>
        Movies
    </h2>
    <div class="table-container">
        <table id="moviesTable" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Added</th>
                    <th>Codec</th>
                    <th>Resolution</th>
                    <th>Rating</th>
                    <th>Size (GB)</th>
                    <th>Last Played</th>
                    <th>Plays</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</div>

<!-- TV Shows Section -->
<div class="section" id="tv-section" {% if not sync_status.has_data %}style="display: none;"{% endif %}>
    <h2 class="section-header">
        <svg class="section-icon" width="24" height="24" viewBox="0 0 24 24" fill="#ed542c">
            <path d="M21 3H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h5v2h8v-2h5c1.1 0 1.99-.9 1.99-2L23 5c0-1.1-.9-2-2-2zm0 14H3V5h18v12z"/>
        </svg>
        TV Shows
    </h2>
    <div class="table-container">
        <table id="tvShowsTable" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Added</th>
                    <th>Rating</th>
                    <th>Size (GB)</th>
                    <th>Last Played</th>
                    <th>Plays</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</div>

<div class="nav-loading-overlay" id="nav-loading-overlay" aria-hidden="true">
    <div class="nav-loading-card" role="status" aria-live="polite">
        <div class="nav-loading-title" id="nav-loading-title">Loading content details...</div>
        <div class="nav-loading-subtitle" id="nav-loading-subtitle">Please wait</div>
        <div class="nav-loading-bar-track">
            <div class="nav-loading-bar-fill"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- DataTables CSS and JS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>

<style>
#stats-grid .stat-card {
    padding: 12px 16px;
}

#stats-grid .stat-number {
    font-size: 1.5em;
    margin-bottom: 2px;
    line-height: 1.1;
}

#stats-grid .stat-label {
    font-size: 0.72em;
    letter-spacing: 0.06em;
}

.media-hero {
    position: relative;
    overflow: hidden;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    background: #171717;
    padding: 20px 22px;
    min-height: 124px;
    margin-bottom: 16px;
}

.media-hero-backdrop {
    position: absolute;
    inset: 0;
    opacity: 0.5;
    display: grid;
    grid-auto-flow: column;
    align-content: start;
    justify-content: start;
}

.media-hero-tile {
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
}

.media-hero-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(10, 10, 10, 0.9) 0%, rgba(14, 14, 14, 0.68) 55%, rgba(12, 12, 12, 0.86) 100%);
}

.media-hero .settings-title,
.media-hero .subtitle {
    position: relative;
    z-index: 2;
}

.media-hero .subtitle {
    max-width: 560px;
    margin-left: auto;
    margin-right: auto;
    text-align: center;
}

.media-load-section {
    max-width: 700px;
    margin: 40px auto;
}

.media-controls-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 8px 0 18px;
    gap: 12px;
}

.load-card {
    text-align: center;
    padding: 40px;
}

.load-header {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    margin-bottom: 30px;
}

.load-icon {
    color: #f18a3d;
}

.load-text h3 {
    margin: 0 0 8px 0;
    font-size: 1.3em;
    color: #fff;
}

.load-text p {
    margin: 0;
    color: #aaa;
}

.load-process-copy {
    margin: 0 auto 18px;
    max-width: 680px;
    text-align: left;
    color: #bdbdbd;
    line-height: 1.45;
}

.load-process-copy p {
    margin: 0 0 8px;
}

.progress-phase-title {
    font-weight: 600;
    color: #f5b27f;
    margin-bottom: 10px;
}

.btn-large {
    padding: 14px 40px;
    font-size: 1.1em;
}

.last-sync-info {
    margin-top: 15px;
    color: #888;
    font-size: 0.9em;
}

.sync-progress {
    margin-bottom: 20px;
    padding: 20px;
    background: rgba(241, 138, 61, 0.1);
    border: 1px solid rgba(241, 138, 61, 0.3);
    border-radius: 8px;
    text-align: left;
}

/* Per-server progress styling */
.server-progress {
    margin-bottom: 15px;
    padding: 12px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 6px;
}

.server-progress:last-child {
    margin-bottom: 0;
}

.server-progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.server-name {
    font-weight: 600;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 8px;
}

.server-status-badge {
    font-size: 0.75em;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 500;
}

.server-status-badge.pending {
    background: rgba(150, 150, 150, 0.3);
    color: #aaa;
}

.server-status-badge.running {
    background: rgba(241, 138, 61, 0.3);
    color: #f18a3d;
}

.server-status-badge.success {
    background: rgba(76, 175, 80, 0.3);
    color: #4caf50;
}

.server-status-badge.failed {
    background: rgba(244, 67, 54, 0.3);
    color: #f44336;
}

.resolution-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}

.resolution-badge.res-4k {
    background: rgba(237, 84, 44, 0.2);
    color: #ed542c;
    border: 1px solid rgba(237, 84, 44, 0.4);
}

.resolution-badge.res-1080 {
    background: rgba(76, 175, 80, 0.2);
    color: #4caf50;
    border: 1px solid rgba(76, 175, 80, 0.4);
}

.resolution-badge.res-720 {
    background: rgba(230, 180, 19, 0.2);
    color: #e6b413;
    border: 1px solid rgba(230, 180, 19, 0.4);
}

.resolution-badge.res-sd {
    background: rgba(244, 67, 54, 0.2);
    color: #f44336;
    border: 1px solid rgba(244, 67, 54, 0.4);
}

.resolution-badge.res-other {
    background: rgba(255, 255, 255, 0.15);
    color: #ddd;
    border: 1px solid rgba(255, 255, 255, 0.25);
}

.server-step {
    font-size: 0.85em;
    color: #f18a3d;
}

.server-progress-bar {
    height: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 6px;
}

.server-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #f18a3d, #ed542c);
    border-radius: 4px;
    transition: width 0.3s ease;
}

.server-progress-fill.success {
    background: linear-gradient(90deg, #4caf50, #45a049);
}

.server-progress-fill.failed {
    background: linear-gradient(90deg, #f44336, #d32f2f);
}

.server-fetched {
    font-size: 0.8em;
    color: #888;
}

.server-error {
    font-size: 0.8em;
    color: #f44336;
    margin-top: 4px;
}

.progress-stats {
    text-align: center;
    color: #aaa;
    font-size: 0.9em;
    margin-top: 15px;
    padding-top: 12px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.media-table-toggle {
    display: flex;
    gap: 12px;
    margin: 0;
}

.media-actions {
    display: flex;
    justify-content: flex-end;
    margin: 0;
    gap: 10px;
}

.media-toggle-btn {
    min-width: 120px;
}

.media-toggle-btn.active {
    background: linear-gradient(135deg, #f18a3d 0%, #ed542c 100%);
    border-color: #ed542c;
    color: #fff;
}

.section-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
    font-size: 1.4em;
    color: #fff;
}

.section-header .section-icon {
    flex-shrink: 0;
}

.section {
    margin-bottom: 40px;
}

.content-link {
    color: #f18a3d;
    text-decoration: none;
    border-bottom: 1px dotted rgba(241, 138, 61, 0.6);
}

.content-link:hover {
    color: #ffaf6e;
}

.nav-loading-overlay {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.6);
    z-index: 13000;
    backdrop-filter: blur(2px);
}

.nav-loading-overlay.is-open {
    display: flex;
}

.nav-loading-card {
    width: min(420px, 86vw);
    background: #1b1b1b;
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 24px 60px rgba(0, 0, 0, 0.45);
}

.nav-loading-title {
    color: #fff;
    font-size: 1.02em;
    font-weight: 600;
}

.nav-loading-subtitle {
    margin-top: 4px;
    color: #bdbdbd;
    font-size: 0.9em;
}

.nav-loading-bar-track {
    margin-top: 14px;
    width: 100%;
    height: 4px;
    border-radius: 999px;
    overflow: hidden;
    background: rgba(255, 255, 255, 0.12);
}

.nav-loading-bar-fill {
    width: 38%;
    height: 100%;
    background: linear-gradient(90deg, #e6b413 0%, #f18a3d 70%, #ed542c 100%);
    border-radius: 999px;
    animation: nav-loading-slide 1.1s ease-in-out infinite;
}

@keyframes nav-loading-slide {
    0% {
        transform: translateX(-120%);
    }
    100% {
        transform: translateX(280%);
    }
}

@media (max-width: 840px) {
    .media-controls-row {
        flex-direction: column;
        align-items: stretch;
    }

    .media-actions {
        justify-content: flex-start;
        flex-wrap: wrap;
    }
}
</style>

<script>
$(document).ready(function() {
    var moviesData = {{ movies | tojson }};
    var tvShowsData = {{ tv_shows | tojson }};
    var mediaStatus = {{ sync_status | tojson }};
    var lifetimeStatus = {{ lifetime_sync_status | tojson }};
    var pollInterval = null;
    var lifetimePollInterval = null;
    var lifetimeSyncWasRunning = false;
    var combinedRefreshRequested = false;
    var combinedWaitingForLifetime = false;
    var launchedFromCompactRefresh = false;
    var navigationInProgress = false;
    var currentMediaView = 'movies';
    var contentDetailBase = '{{ url_for("main.media_content_details", media_id=0) }}';
    var mediaHeroRows = 2;
    var mediaHeroGap = 2;
    var mediaHeroOverflowColumns = 3;
    var mediaHeroPosters = [];
    var mediaHeroBackdrop = document.getElementById('media-hero-backdrop');
    var mediaHeroElement = document.getElementById('media-hero');
    var mediaHeroResizeTimer = null;

    function calculateMediaHeroQuiltLayout() {
        if (!mediaHeroBackdrop || !mediaHeroElement) {
            return null;
        }

        var heroHeight = Math.max(124, mediaHeroElement.clientHeight || 0);
        var heroWidth = Math.max(320, mediaHeroElement.clientWidth || 0);
        var tileHeight = Math.max(60, Math.floor((heroHeight - mediaHeroGap * (mediaHeroRows - 1)) / mediaHeroRows));
        var tileWidth = Math.max(40, Math.round(tileHeight * (2 / 3))); // poster ratio 2:3
        var columns = Math.max(1, Math.ceil(heroWidth / (tileWidth + mediaHeroGap)) + mediaHeroOverflowColumns);

        return {
            rows: mediaHeroRows,
            gap: mediaHeroGap,
            tileHeight: tileHeight,
            tileWidth: tileWidth,
            columns: columns,
            tileCount: columns * mediaHeroRows
        };
    }

    function renderMediaHeroPosters(posters) {
        if (!mediaHeroBackdrop) {
            return;
        }

        mediaHeroBackdrop.innerHTML = '';
        if (!Array.isArray(posters) || posters.length === 0) {
            return;
        }

        var normalizedPosters = posters.filter(function(item) {
            return item && item.poster_url;
        });
        if (normalizedPosters.length === 0) {
            return;
        }

        var layout = calculateMediaHeroQuiltLayout();
        if (!layout) {
            return;
        }

        mediaHeroBackdrop.style.gridTemplateRows = 'repeat(' + layout.rows + ', ' + layout.tileHeight + 'px)';
        mediaHeroBackdrop.style.gridAutoColumns = layout.tileWidth + 'px';
        mediaHeroBackdrop.style.rowGap = layout.gap + 'px';
        mediaHeroBackdrop.style.columnGap = layout.gap + 'px';

        for (var i = 0; i < layout.tileCount; i++) {
            var item = normalizedPosters[i % normalizedPosters.length];
            var posterUrl = String(item.poster_url || '').replace(/"/g, '\\"');
            var tile = document.createElement('div');
            tile.className = 'media-hero-tile';
            tile.style.backgroundImage = 'url("' + posterUrl + '")';
            if (item.title) {
                tile.setAttribute('title', item.title);
            }
            mediaHeroBackdrop.appendChild(tile);
        }
    }

    function loadMediaHeroPosters() {
        fetch('{{ url_for("main.api_media_top_posters") }}')
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('Failed to load media hero posters.');
                }
                return response.json();
            })
            .then(function(payload) {
                mediaHeroPosters = Array.isArray(payload.posters) ? payload.posters : [];
                renderMediaHeroPosters(mediaHeroPosters);
            })
            .catch(function(error) {
                console.error('Error loading media hero posters:', error);
            });
    }

    function scheduleMediaHeroRerender() {
        if (!mediaHeroPosters.length) {
            return;
        }
        if (mediaHeroResizeTimer) {
            clearTimeout(mediaHeroResizeTimer);
        }
        mediaHeroResizeTimer = setTimeout(function() {
            renderMediaHeroPosters(mediaHeroPosters);
        }, 120);
    }

    function escapeHtml(value) {
        return String(value || '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function showNavigationLoading(titleText) {
        var overlay = document.getElementById('nav-loading-overlay');
        var titleEl = document.getElementById('nav-loading-title');
        var subtitleEl = document.getElementById('nav-loading-subtitle');
        if (!overlay || !titleEl || !subtitleEl) {
            return;
        }
        titleEl.textContent = 'Loading content details...';
        subtitleEl.textContent = titleText || 'Please wait';
        overlay.classList.add('is-open');
        overlay.setAttribute('aria-hidden', 'false');
    }

    function setDataSectionsVisible(visible) {
        var displayValue = visible ? 'block' : 'none';
        var statsGrid = document.getElementById('stats-grid');
        var mediaControls = document.getElementById('media-controls-row');
        var moviesSection = document.getElementById('movies-section');
        var tvSection = document.getElementById('tv-section');

        if (statsGrid) statsGrid.style.display = displayValue;
        if (mediaControls) mediaControls.style.display = visible ? 'flex' : 'none';
        if (moviesSection) moviesSection.style.display = displayValue;
        if (tvSection) tvSection.style.display = 'none';

        if (visible) {
            setMediaTableView('movies');
        }
    }

    function showStarterLoadState() {
        var loadSection = document.getElementById('media-load-section');
        var mediaControls = document.getElementById('media-controls-row');
        if (loadSection) {
            loadSection.style.display = 'block';
        }
        if (mediaControls) {
            mediaControls.style.display = 'none';
        }
    }

    function restoreLoadedViewAfterFailedCompactRefresh() {
        if (!launchedFromCompactRefresh) {
            return;
        }
        launchedFromCompactRefresh = false;

        var loadSection = document.getElementById('media-load-section');
        var mediaControls = document.getElementById('media-controls-row');
        if (loadSection) {
            loadSection.style.display = 'none';
        }
        if (mediaControls) {
            mediaControls.style.display = 'flex';
        }
        setDataSectionsVisible(true);
    }

    function getRunButtonLabel(hasData) {
        return hasData ? 'Refresh Media Data' : 'Load Media Data';
    }

    function setCombinedRefreshButtonState(disabled, text) {
        var button = document.getElementById('run-full-refresh-btn');
        if (!button) {
            return;
        }
        button.disabled = !!disabled;
        button.textContent = text || getRunButtonLabel(!!(mediaStatus && mediaStatus.has_data));
    }

    function formatLastUpdatedValue(isoString) {
        if (!isoString) {
            return 'Never';
        }
        var parsed = new Date(isoString);
        if (isNaN(parsed.getTime())) {
            return isoString;
        }
        return parsed.toLocaleString();
    }

    function renderLifetimeServerProgress(servers) {
        var container = document.getElementById('lifetime-server-progress-container');
        if (!container) {
            return;
        }

        var html = '';
        (servers || []).forEach(function(server) {
            var percent = 0;
            if (server.total && server.total > 0) {
                percent = Math.min(100, (server.fetched / server.total) * 100);
            } else if (server.status === 'success') {
                percent = 100;
            }

            var fillClass = '';
            if (server.status === 'success') fillClass = 'success';
            else if (server.status === 'failed') fillClass = 'failed';

            html += '<div class="server-progress">';
            html += '<div class="server-progress-header">';
            html += '<span class="server-name">' + (server.name || 'Server');
            html += '<span class="server-status-badge ' + (server.status || 'idle') + '">' + (server.status || 'idle') + '</span>';
            html += '</span>';
            html += '<span class="server-step">' + (server.step || '') + '</span>';
            html += '</div>';
            html += '<div class="server-progress-bar">';
            html += '<div class="server-progress-fill ' + fillClass + '" style="width: ' + percent + '%;"></div>';
            html += '</div>';
            html += '<div class="server-fetched">' + ((server.fetched || 0).toLocaleString()) + ' rows';
            if (server.total) {
                html += ' / ' + server.total.toLocaleString() + ' total';
            }
            html += '</div>';
            if (server.error) {
                html += '<div class="server-error">' + server.error + '</div>';
            }
            html += '</div>';
        });
        container.innerHTML = html;
    }

    function updateLifetimeSyncStatus(status) {
        status = status || {};
        lifetimeStatus = status;
        var progress = document.getElementById('lifetime-sync-progress');
        var lastSyncLabel = document.getElementById('lifetime-last-sync-label');
        var fetchedLabel = document.getElementById('lifetime-progress-fetched');

        if (!progress || !lastSyncLabel || !fetchedLabel) {
            return;
        }

        lastSyncLabel.textContent = 'Last lifetime cache refresh: ' + formatLastUpdatedValue(status.last_sync_date);

        if (status.status === 'running') {
            lifetimeSyncWasRunning = true;
            progress.style.display = 'block';
            setCombinedRefreshButtonState(true, 'Building Lifetime Play Counts...');
            fetchedLabel.textContent = (status.records_fetched || 0).toLocaleString();
            renderLifetimeServerProgress(status.servers || []);

            if (!lifetimePollInterval) {
                lifetimePollInterval = setInterval(pollLifetimeStatus, 1000);
            }
            return;
        }

        progress.style.display = 'none';
        renderLifetimeServerProgress(status.servers || []);

        if (lifetimePollInterval) {
            clearInterval(lifetimePollInterval);
            lifetimePollInterval = null;
        }

        if (lifetimeSyncWasRunning) {
            if (combinedRefreshRequested) {
                combinedRefreshRequested = false;
                combinedWaitingForLifetime = false;
                setCombinedRefreshButtonState(false, getRunButtonLabel(!!(mediaStatus && mediaStatus.has_data)));
            }
            lifetimeSyncWasRunning = false;
            if (status.status === 'success') {
                window.location.reload();
                return;
            } else if (status.status === 'failed' && status.error_message) {
                alert('Lifetime play count sync failed: ' + status.error_message);
                restoreLoadedViewAfterFailedCompactRefresh();
            }
        }
    }

    function pollLifetimeStatus() {
        fetch('{{ url_for("main.api_media_lifetime_stats_status") }}')
            .then(function(response) { return response.json(); })
            .then(function(data) { updateLifetimeSyncStatus(data); })
            .catch(function(error) { console.error('Error polling lifetime status:', error); });
    }

    function startLifetimeSync() {
        var progress = document.getElementById('lifetime-sync-progress');
        if (!progress) {
            return;
        }

        setCombinedRefreshButtonState(true, 'Building Lifetime Play Counts...');
        progress.style.display = 'block';

        fetch('{{ url_for("main.api_media_lifetime_stats_start") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(function(response) {
            return response.json().then(function(payload) {
                if (!response.ok && response.status !== 409) {
                    throw new Error(payload.error || 'Failed to start lifetime sync');
                }
                return payload;
            });
        })
        .then(function() {
            if (!lifetimePollInterval) {
                lifetimePollInterval = setInterval(pollLifetimeStatus, 1000);
            }
            pollLifetimeStatus();
        })
        .catch(function(error) {
            alert(error.message);
            progress.style.display = 'none';
            if (combinedRefreshRequested) {
                combinedRefreshRequested = false;
                combinedWaitingForLifetime = false;
                setCombinedRefreshButtonState(false, getRunButtonLabel(!!(mediaStatus && mediaStatus.has_data)));
            }
            restoreLoadedViewAfterFailedCompactRefresh();
        });
    }

    // Rating display helper functions
    function getRatingIcon(ratingImage) {
        if (!ratingImage) return '';
        if (ratingImage.startsWith('imdb://')) {
            return '<img src="{{ url_for("static", filename="img/imdb.svg") }}" class="rating-icon" alt="IMDb">';
        }
        if (ratingImage.startsWith('rottentomatoes://')) {
            return '<img src="{{ url_for("static", filename="img/rottentomatoes.svg") }}" class="rating-icon" alt="Rotten Tomatoes">';
        }
        if (ratingImage.startsWith('themoviedb://')) {
            return '<img src="{{ url_for("static", filename="img/themoviedb.svg") }}" class="rating-icon" alt="TMDb">';
        }
        return '';
    }

    function normalizeResolutionLabel(value) {
        if (!value) {
            return { label: '', className: 'res-other' };
        }
        var lower = value.trim().toLowerCase();
        if (lower === '4k' || lower === '2160p' || lower === 'uhd') {
            return { label: '4K', className: 'res-4k' };
        }
        if (lower === '1080p' || lower === '1080') {
            return { label: '1080p', className: 'res-1080' };
        }
        if (lower === '720p' || lower === '720') {
            return { label: '720p', className: 'res-720' };
        }
        if (lower === '480p' || lower === '480' || lower === 'sd') {
            return { label: 'SD', className: 'res-sd' };
        }
        return { label: value.trim(), className: 'res-other' };
    }

    function formatResolutionBadges(value) {
        if (!value) {
            return '-';
        }
        var parts = value.split(/[|,]/).map(function(part) {
            return part.trim();
        }).filter(Boolean);

        if (!parts.length) {
            return '-';
        }

        var html = '<div class="resolution-badges">';
        parts.forEach(function(part) {
            var normalized = normalizeResolutionLabel(part);
            if (!normalized.label) {
                return;
            }
            html += '<span class="quality-badge resolution-badge ' + normalized.className + '">' + normalized.label + '</span>';
        });
        html += '</div>';
        return html;
    }

    function formatResolutionText(value) {
        if (!value) {
            return '';
        }
        return value.replace(/\s*\|\s*/g, ' ').trim();
    }

    function getRatingMeta(value, ratingImage) {
        if (value === null || value === undefined || value === '') {
            return null;
        }
        var num = parseFloat(value);
        if (isNaN(num)) {
            return { display: String(value), className: '' };
        }

        var source = ratingImage ? ratingImage.toLowerCase() : '';
        var type = 'score';

        if (source.startsWith('rottentomatoes://')) {
            type = 'percent';
            if (num > 0 && num <= 1) {
                num = num * 100;
            } else if (num > 1 && num <= 10) {
                num = num * 10;
            }
        } else if (
            source.startsWith('imdb://') ||
            source.startsWith('themoviedb://') ||
            source.startsWith('thetvdb://') ||
            source.startsWith('tvdb://')
        ) {
            type = 'score';
        } else if (num > 10) {
            type = 'percent';
        }

        var display = type === 'percent' ? Math.round(num) + '%' : num.toFixed(1);
        var className = '';

        if (type === 'percent') {
            if (num > 69) {
                className = 'rating-good';
            } else if (num >= 60) {
                className = 'rating-warn';
            } else {
                className = 'rating-bad';
            }
        } else {
            if (num > 6.9) {
                className = 'rating-good';
            } else if (num >= 6.0) {
                className = 'rating-warn';
            } else {
                className = 'rating-bad';
            }
        }

        return { display: display, className: className };
    }

    function formatRatingValue(value, ratingImage) {
        var meta = getRatingMeta(value, ratingImage);
        return meta ? meta.display : '';
    }

    function updateExportButtonLabel() {
        var button = document.getElementById('export-section-btn');
        if (!button) {
            return;
        }
        button.textContent = currentMediaView === 'tv' ? 'Export TV Shows CSV' : 'Export Movies CSV';
    }

    function escapeCsvCell(value) {
        var text = String(value == null ? '' : value);
        if (/[",\n]/.test(text)) {
            return '"' + text.replace(/"/g, '""') + '"';
        }
        return text;
    }

    function downloadCsv(filename, rows) {
        var csv = rows.map(function(row) {
            return row.map(escapeCsvCell).join(',');
        }).join('\n');

        var blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
        var url = window.URL.createObjectURL(blob);
        var link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
    }

    function formatMovieSizeForCsv(row) {
        if (row.file_size_versions) {
            return row.file_size_versions;
        }
        if (row.file_size || row.file_size === 0) {
            return Number(row.file_size).toFixed(2);
        }
        return '';
    }

    function formatTvSizeForCsv(row) {
        if (row.file_size || row.file_size === 0) {
            return Number(row.file_size).toFixed(2);
        }
        return '';
    }

    function formatRatingForCsv(row) {
        var critic = formatRatingValue(row.rating, row.rating_image);
        var audience = formatRatingValue(row.audience_rating, row.audience_rating_image);
        if (critic && audience) {
            return 'Critic: ' + critic + ' | Audience: ' + audience;
        }
        return critic || audience || '';
    }

    function buildTimestampForFilename() {
        var now = new Date();
        var yyyy = now.getFullYear();
        var mm = String(now.getMonth() + 1).padStart(2, '0');
        var dd = String(now.getDate()).padStart(2, '0');
        var hh = String(now.getHours()).padStart(2, '0');
        var mi = String(now.getMinutes()).padStart(2, '0');
        return yyyy + '-' + mm + '-' + dd + '_' + hh + mi;
    }

    function exportCurrentSectionCsv() {
        var timestamp = buildTimestampForFilename();

        if (currentMediaView === 'tv') {
            var tvRows = tvShowsTable.rows().data().toArray();
            var tvCsvRows = [['Title', 'Added', 'Rating', 'Size (GB)', 'Last Played', 'Plays']];
            tvRows.forEach(function(row) {
                tvCsvRows.push([
                    row.title || '',
                    row.added_at || '',
                    formatRatingForCsv(row),
                    formatTvSizeForCsv(row),
                    row.last_played || '',
                    row.play_count == null ? '' : row.play_count
                ]);
            });
            downloadCsv('tv_shows_' + timestamp + '.csv', tvCsvRows);
            return;
        }

        var movieRows = moviesTable.rows().data().toArray();
        var movieCsvRows = [['Title', 'Added', 'Codec', 'Resolution', 'Rating', 'Size (GB)', 'Last Played', 'Plays']];
        movieRows.forEach(function(row) {
            movieCsvRows.push([
                row.title || '',
                row.added_at || '',
                row.video_codec || '',
                formatResolutionText(row.video_resolution),
                formatRatingForCsv(row),
                formatMovieSizeForCsv(row),
                row.last_played || '',
                row.play_count == null ? '' : row.play_count
            ]);
        });
        downloadCsv('movies_' + timestamp + '.csv', movieCsvRows);
    }

    function formatRatingCell(row) {
        var html = '<div class="rating-cell">';
        var hasRating = false;

        if (row.rating && row.rating_image) {
            var icon = getRatingIcon(row.rating_image);
            var meta = getRatingMeta(row.rating, row.rating_image);
            var value = meta ? meta.display : '';
            var ratingClass = meta ? meta.className : '';
            html += '<div class="rating-item">' + icon;
            html += '<span class="rating-value critic ' + ratingClass + '">' + value + '</span></div>';
            hasRating = true;
        }
        if (row.audience_rating && row.audience_rating_image) {
            var icon = getRatingIcon(row.audience_rating_image);
            var meta = getRatingMeta(row.audience_rating, row.audience_rating_image);
            var value = meta ? meta.display : '';
            var ratingClass = meta ? meta.className : '';
            html += '<div class="rating-item">' + icon;
            html += '<span class="rating-value audience ' + ratingClass + '">' + value + '</span></div>';
            hasRating = true;
        }
        html += '</div>';
        return hasRating ? html : '-';
    }

    function setMediaTableView(view) {
        var moviesSection = document.getElementById('movies-section');
        var tvSection = document.getElementById('tv-section');
        var moviesBtn = document.getElementById('media-tab-movies');
        var tvBtn = document.getElementById('media-tab-tv');

        if (!moviesSection || !tvSection || !moviesBtn || !tvBtn) {
            return;
        }

        if (view === 'tv') {
            currentMediaView = 'tv';
            moviesSection.style.display = 'none';
            tvSection.style.display = 'block';
            moviesBtn.classList.remove('active');
            tvBtn.classList.add('active');
            if (tvShowsTable) {
                tvShowsTable.columns.adjust().draw(false);
            }
        } else {
            currentMediaView = 'movies';
            moviesSection.style.display = 'block';
            tvSection.style.display = 'none';
            moviesBtn.classList.add('active');
            tvBtn.classList.remove('active');
            if (moviesTable) {
                moviesTable.columns.adjust().draw(false);
            }
        }
        updateExportButtonLabel();
    }

    // Initialize Movies DataTable
    var moviesTable = $('#moviesTable').DataTable({
        data: moviesData,
        pageLength: 50,
        lengthMenu: [[50, 100, 200, 500], [50, 100, 200, 500]],
        order: [[1, 'desc']],
        columns: [
            {
                data: 'title',
                render: function(data, type, row) {
                    if (type !== 'display') {
                        return data || '';
                    }
                    var safeTitle = escapeHtml(data || '');
                    if (!row.media_id) {
                        return '<span class="content-title">' + safeTitle + '</span>';
                    }
                    var href = contentDetailBase.replace(/0$/, String(row.media_id));
                    return '<a class="content-title content-link" href="' + href + '">' + safeTitle + '</a>';
                }
            },
            { data: 'added_at' },
            { data: 'video_codec' },
            {
                data: 'video_resolution',
                render: function(data, type) {
                    if (type === 'display') {
                        return formatResolutionBadges(data);
                    }
                    return formatResolutionText(data);
                }
            },
            {
                data: 'rating',
                render: function(data, type, row) {
                    if (type === 'display') {
                        return formatRatingCell(row);
                    }
                    return parseFloat(data) || 0;
                }
            },
            {
                data: 'file_size',
                render: function(data, type, row) {
                    if (type === 'display') {
                        if (row.file_size_versions) {
                            return row.file_size_versions;
                        }
                        return data ? data.toFixed(2) : '-';
                    }
                    return data || 0;
                }
            },
            { data: 'last_played' },
            { data: 'play_count' }
        ],
        language: {
            search: "Filter:",
            lengthMenu: "Show _MENU_ movies",
            info: "Showing _START_ to _END_ of _TOTAL_ movies",
            infoEmpty: "No movies available",
            emptyTable: "No movies loaded"
        }
    });

    // Initialize TV Shows DataTable
    var tvShowsTable = $('#tvShowsTable').DataTable({
        data: tvShowsData,
        pageLength: 50,
        lengthMenu: [[50, 100, 200, 500], [50, 100, 200, 500]],
        order: [[1, 'desc']],
        columns: [
            {
                data: 'title',
                render: function(data, type, row) {
                    if (type !== 'display') {
                        return data || '';
                    }
                    var safeTitle = escapeHtml(data || '');
                    if (!row.media_id) {
                        return '<span class="content-title">' + safeTitle + '</span>';
                    }
                    var href = contentDetailBase.replace(/0$/, String(row.media_id));
                    return '<a class="content-title content-link" href="' + href + '">' + safeTitle + '</a>';
                }
            },
            { data: 'added_at' },
            {
                data: 'rating',
                render: function(data, type, row) {
                    if (type === 'display') {
                        return formatRatingCell(row);
                    }
                    return parseFloat(data) || 0;
                }
            },
            {
                data: 'file_size',
                render: function(data) {
                    return data ? data.toFixed(2) : '-';
                }
            },
            { data: 'last_played' },
            { data: 'play_count' }
        ],
        language: {
            search: "Filter:",
            lengthMenu: "Show _MENU_ shows",
            info: "Showing _START_ to _END_ of _TOTAL_ TV shows",
            infoEmpty: "No TV shows available",
            emptyTable: "No TV shows loaded"
        }
    });

    $('#media-tab-movies').on('click', function() {
        setMediaTableView('movies');
    });

    $('#media-tab-tv').on('click', function() {
        setMediaTableView('tv');
    });

    setMediaTableView('movies');

    function renderServerProgress(servers) {
        var container = document.getElementById('server-progress-container');
        var html = '';

        servers.forEach(function(server) {
            var percent = 0;
            if (server.total && server.total > 0) {
                percent = Math.min(100, (server.fetched / server.total) * 100);
            } else if (server.status === 'success') {
                percent = 100;
            }

            var fillClass = '';
            if (server.status === 'success') fillClass = 'success';
            else if (server.status === 'failed') fillClass = 'failed';

            html += '<div class="server-progress">';
            html += '<div class="server-progress-header">';
            html += '<span class="server-name">' + server.name;
            html += '<span class="server-status-badge ' + server.status + '">' + server.status + '</span>';
            html += '</span>';
            html += '<span class="server-step">' + (server.step || '') + '</span>';
            html += '</div>';
            html += '<div class="server-progress-bar">';
            html += '<div class="server-progress-fill ' + fillClass + '" style="width: ' + percent + '%;"></div>';
            html += '</div>';
            html += '<div class="server-fetched">' + (server.fetched || 0).toLocaleString() + ' records';
            if (server.total) {
                html += ' / ' + server.total.toLocaleString() + ' total';
            }
            html += '</div>';
            if (server.error) {
                html += '<div class="server-error">' + server.error + '</div>';
            }
            html += '</div>';
        });

        container.innerHTML = html;
    }

    function updateProgress(status) {
        mediaStatus = status || {};
        var progressDiv = document.getElementById('sync-progress');
        var mediaLastSyncLabel = document.getElementById('media-last-sync-label');
        if (!progressDiv) {
            return;
        }

        if (mediaLastSyncLabel) {
            mediaLastSyncLabel.textContent = 'Last media load: ' + formatLastUpdatedValue(status.last_sync_date);
        }

        if (status.status === 'running') {
            progressDiv.style.display = 'block';
            setCombinedRefreshButtonState(true, 'Loading Media Library...');

            if (status.servers && status.servers.length > 0) {
                renderServerProgress(status.servers);
            }

            document.getElementById('progress-fetched').textContent = (status.records_fetched || 0).toLocaleString();
            return;
        }

        progressDiv.style.display = 'none';

        if (status.status === 'success') {
            if ((combinedRefreshRequested || !lifetimeStatus.has_data) && !combinedWaitingForLifetime) {
                combinedRefreshRequested = true;
                combinedWaitingForLifetime = true;
                setCombinedRefreshButtonState(true, 'Building Lifetime Play Counts...');
                startLifetimeSync();
            } else {
                window.location.reload();
            }
        } else if (status.status === 'failed' && status.error_message) {
            alert('Media load failed: ' + status.error_message);
            if (combinedRefreshRequested) {
                combinedRefreshRequested = false;
                combinedWaitingForLifetime = false;
            }
            setCombinedRefreshButtonState(false, getRunButtonLabel(!!status.has_data));
            restoreLoadedViewAfterFailedCompactRefresh();
        } else {
            setCombinedRefreshButtonState(false, getRunButtonLabel(!!status.has_data));
        }

        if (pollInterval) {
            clearInterval(pollInterval);
            pollInterval = null;
        }
    }

    function pollStatus() {
        fetch('{{ url_for("main.api_media_status") }}')
            .then(function(response) { return response.json(); })
            .then(function(data) { updateProgress(data); })
            .catch(function(error) { console.error('Error polling status:', error); });
    }

    function startMediaLoad() {
        setCombinedRefreshButtonState(true, 'Loading Media Library...');
        var progressDiv = document.getElementById('sync-progress');
        if (progressDiv) {
            progressDiv.style.display = 'block';
        }

        fetch('{{ url_for("main.api_media_start_load") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(function(response) {
            return response.json().then(function(payload) {
                if (!response.ok && response.status !== 409) {
                    throw new Error(payload.error || 'Failed to start media load');
                }
                return payload;
            });
        })
        .then(function() {
            if (!pollInterval) {
                pollInterval = setInterval(pollStatus, 1000);
            }
            pollStatus();
        })
        .catch(function(error) {
            alert(error.message);
            if (progressDiv) {
                progressDiv.style.display = 'none';
            }
            if (combinedRefreshRequested) {
                combinedRefreshRequested = false;
                combinedWaitingForLifetime = false;
            }
            setCombinedRefreshButtonState(false, getRunButtonLabel(!!(mediaStatus && mediaStatus.has_data)));
            restoreLoadedViewAfterFailedCompactRefresh();
        });
    }

    function startCombinedRefresh() {
        if (combinedRefreshRequested) {
            return;
        }

        if (mediaStatus && mediaStatus.status === 'running') {
            combinedRefreshRequested = true;
            combinedWaitingForLifetime = false;
            setCombinedRefreshButtonState(true, 'Loading Media Library...');
            if (!pollInterval) {
                pollInterval = setInterval(pollStatus, 1000);
            }
            pollStatus();
            return;
        }

        if (lifetimeStatus && lifetimeStatus.status === 'running') {
            combinedRefreshRequested = true;
            combinedWaitingForLifetime = true;
            setCombinedRefreshButtonState(true, 'Building Lifetime Play Counts...');
            if (!lifetimePollInterval) {
                lifetimePollInterval = setInterval(pollLifetimeStatus, 1000);
            }
            pollLifetimeStatus();
            return;
        }

        combinedRefreshRequested = true;
        combinedWaitingForLifetime = false;
        setCombinedRefreshButtonState(true, 'Loading Media Library...');
        startMediaLoad();
    }

    // Bind click handlers
    var runFullRefreshButton = document.getElementById('run-full-refresh-btn');
    if (runFullRefreshButton) {
        runFullRefreshButton.addEventListener('click', startCombinedRefresh);
    }

    var exportSectionButton = document.getElementById('export-section-btn');
    if (exportSectionButton) {
        exportSectionButton.addEventListener('click', exportCurrentSectionCsv);
    }

    var inlineRefreshButton = document.getElementById('refresh-media-inline-btn');
    if (inlineRefreshButton) {
        inlineRefreshButton.addEventListener('click', function() {
            launchedFromCompactRefresh = true;
            showStarterLoadState();
            setDataSectionsVisible(false);
            startCombinedRefresh();
        });
    }

    if (mediaStatus && mediaStatus.status === 'running') {
        combinedRefreshRequested = true;
        combinedWaitingForLifetime = false;
        showStarterLoadState();
        setCombinedRefreshButtonState(true, 'Loading Media Library...');
        pollInterval = setInterval(pollStatus, 1000);
    }

    if (lifetimeStatus && lifetimeStatus.status === 'running') {
        combinedRefreshRequested = true;
        combinedWaitingForLifetime = true;
        showStarterLoadState();
        setCombinedRefreshButtonState(true, 'Building Lifetime Play Counts...');
        if (!lifetimePollInterval) {
            lifetimePollInterval = setInterval(pollLifetimeStatus, 1000);
        }
    }

    updateLifetimeSyncStatus(lifetimeStatus);

    if (!combinedRefreshRequested) {
        setCombinedRefreshButtonState(false, getRunButtonLabel(!!(mediaStatus && mediaStatus.has_data)));
    }
    updateExportButtonLabel();
    loadMediaHeroPosters();
    window.addEventListener('resize', scheduleMediaHeroRerender);

    $('#moviesTable, #tvShowsTable').on('click', 'a.content-link', function(event) {
        var href = this.getAttribute('href');
        if (!href) {
            return;
        }

        if (
            event.metaKey ||
            event.ctrlKey ||
            event.shiftKey ||
            event.altKey ||
            (typeof event.button === 'number' && event.button !== 0)
        ) {
            return;
        }

        event.preventDefault();
        if (navigationInProgress) {
            return;
        }

        navigationInProgress = true;
        showNavigationLoading((this.textContent || '').trim());
        window.setTimeout(function() {
            window.location.href = href;
        }, 35);
    });
});
</script>
{% endblock %}
